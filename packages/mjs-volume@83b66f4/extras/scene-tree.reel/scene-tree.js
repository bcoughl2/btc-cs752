var Component=require("montage/ui/component").Component,Dict=require("collections/dict"),SceneTreeFactory=require("./core/scene-tree-factory").SceneTreeFactory,Application=require("montage/core/application").Application,Node=require("runtime/node").Node,DEFAULT_VALUES={indentValue:10,indentUnit:"px",meshesEnabled:!1,displayNodeType:!0};exports.SceneTree=Component.specialize({constructor:{value:function(){this.super(),this.configuration=Dict(),this._treeFactory=new SceneTreeFactory(this.configuration),this._populateConfiguration()}},_treeFactory:{value:null},configuration:{value:null},_scene:{value:null},scene:{set:function(e){e&&"object"==typeof e&&(this._scene=e)},get:function(){return this._scene}},selectedNode:{value:null},_sceneGraphTree:{value:null},sceneGraphTree:{set:function(e){e&&(this._sceneGraphTree=this._treeFactory.buildWithGlTFTree(e))},get:function(){return this._sceneGraphTree}},isCellDraggable:{value:null},treeController:{value:null},rangeController:{value:null},enterDocument:{value:function(e){e&&(this.addOwnPropertyChangeListener("selectedNode",this),this.addPathChangeListener("scene.status",this,"handleStatusChange"),Application.addEventListener("sceneNodeSelected",this))}},exitDocument:{value:function(){this.removeOwnPropertyChangeListener("selectedNode",this),this.removePathChangeListener("scene.status",this),Application.removeEventListener("sceneNodeSelected",this)}},handleSceneNodeSelected:{value:function(e){var t=e.detail,n=this.selectedNode,i=n&&n.content.glTFElement.baseId===t.id;t&&!i&&(this.selectTreeControllerNodeById(t.id),this.needsDraw=!0)}},_populateConfiguration:{value:function(){var e=this;Object.keys(DEFAULT_VALUES).forEach(function(t){e.configuration.set(t,DEFAULT_VALUES[t])})}},_createNodeFromGlTFElement:{value:function(e){var t=new Node;return this.scene.glTFElement.ids[e.baseId]=e,t.scene=this._scene,t.id=e.baseId,e.component3D=t,t}},_getComponent3DFromGlTFElement:{value:function(e){return e.component3D?e.component3D:this._createNodeFromGlTFElement(e)}},handleStatusChange:{value:function(e){"loaded"===e&&this._scene&&(this.sceneGraphTree=this._scene.rootNode.glTFElement)}},handleSelectedNodeChange:{value:function(e){if(e&&e.content&&e.content.glTFElement){var t=this._getComponent3DFromGlTFElement(e.content.glTFElement);Application.dispatchEventNamed("sceneNodeSelected",!0,!0,t)}}},_findSceneTreeNodeById:{value:function(e,t){var n=null,i=this,r=null;if(t){var a=t.rawChildren;r=Object.keys(a).map(function(e){return a[e]})}else r=this.treeController.root.content.children;return r.some(function(t){return t.glTFElement&&t.glTFElement.baseId===e?(n=t,!0):(n=i._findSceneTreeNodeById(e,t),!!n)}),n}},_fulfillSceneTreeNodePath:{value:function(e){Array.isArray(e)&&e.forEach(function(e){e.fulfilled||e.fulfill()})}},_expandTreeControllerNode:{value:function(e){e&&(e.expanded||(e.expanded=!0),this._expandTreeControllerNode(e.parent))}},_findTreeControllerNodeById:{value:function(e){var t=this.treeController.root.nodes,n=null;return t.some(function(t){var i=t.content;return i.glTFElement&&i.glTFElement.baseId===e&&(n=t),!!n}),n}},selectTreeControllerNodeById:{value:function(e){if(this.treeController&&this.treeController.root){var t=this._findSceneTreeNodeById(e);if(t){var n=t.toParentPath();if(n){this._fulfillSceneTreeNodePath(n);var i=this._findTreeControllerNodeById(e);this._expandTreeControllerNode(i.parent),this.rangeController.select(i)}}}}}});