require("runtime/dependencies/gl-matrix");var glTFParser=require("runtime/glTF-parser").glTFParser,ResourceDescription=require("runtime/resource-description").ResourceDescription,Technique=require("runtime/technique").Technique,ProgramPass=require("runtime/pass").ProgramPass,Pass=require("runtime/pass").Pass,ScenePass=require("runtime/pass").ScenePass,GLSLProgram=require("runtime/glsl-program").GLSLProgram,glTFMaterial=require("runtime/glTF-material").glTFMaterial,Mesh=require("runtime/mesh").Mesh,glTFNode=require("runtime/glTF-node").glTFNode,Primitive=require("runtime/primitive").Primitive,Projection=require("runtime/projection").Projection,Camera=require("runtime/camera").Camera,Skin=require("runtime/skin").Skin,glTFScene=require("runtime/glTF-scene").glTFScene,Transform=require("runtime/transform").Transform,KeyframeAnimation=require("runtime/animation").KeyframeAnimation,AnimationManager=require("runtime/animation-manager").AnimationManager;exports.RuntimeTFLoader=Object.create(glTFParser,{_materials:{writable:!0,value:null},_scenes:{writable:!0,value:null},_animations:{writable:!0,value:null},totalBufferSize:{value:0,writable:!0},handleBuffer:{value:function(e,t){var i=Object.create(ResourceDescription).init(e,t);return i.id=e,this.storeEntry(e,i,t),this.totalBufferSize+=t.byteLength,!0}},handleBufferView:{value:function(e,t){var i=Object.create(ResourceDescription).init(e,t);i.id=e;var n=this.getEntry(i.description.buffer);return t.type="ArrayBufferView",i.buffer=n,this.storeEntry(e,i,t),!0}},handleShader:{value:function(e,t){var i=Object.create(ResourceDescription).init(e,t);return i.id=e,i.type="shader",this.storeEntry(e,i,t),!0}},handleProgram:{value:function(e,t){var i=Object.create(ResourceDescription).init(e,t);i.id=e,i.type="program";var n=this.getEntry(i.description.vertexShader),r=this.getEntry(i.description.fragmentShader);return i[GLSLProgram.VERTEX_SHADER]=n.entry,i[GLSLProgram.FRAGMENT_SHADER]=r.entry,this.storeEntry(e,i,t),!0}},handleImage:{value:function(e,t){var i=t.path,n=Object.create(ResourceDescription).init(i,{path:i});return n.type="image",this.storeEntry(e,n,t),!0}},handleVideo:{value:function(e,t){var i=t.path,n=Object.create(ResourceDescription).init(i,{path:i});return n.type="video",this.storeEntry(e,n,t),!0}},handleTechnique:{value:function(e,t){var i=Object.create(Technique);i.id=e;var n=this.storeEntry(e,i,t),r=t.pass;i.passName=r;var a=t.passes;if(!a)return console.log("ERROR: technique does not contain pass"),!1;var s={},o=Object.keys(t.passes);return o.forEach(function(e){var t=a[e],i=t.instanceProgram;if(!i)return console.log("ERROR: A Pass with type=program must have a program property"),!1;var o=Object.create(ProgramPass).init();o.id=n+"_"+r,o.instanceProgram=t.instanceProgram,o.instanceProgram.program=this.getEntry(i.program).entry,o.states=t.states,s[e]=o},this),i.parameters=t.parameters,i.passes=s,!0}},handleMaterial:{value:function(e,t){var i=Object.create(glTFMaterial).init(e);this.storeEntry(e,i,t);var n=t.instanceTechnique,r=n.values;i.name=t.name;var a=this.getEntry(n.technique);if(!a)return console.log("ERROR: invalid file, cannot find referenced technique:"+t.technique),!1;i.technique=a.entry;var s=i.technique.parameters;if(i.parameters=JSON.parse(JSON.stringify(s)),r){var o;for(o in r){var l=i.parameters[o];if(l)switch(l.value=r[o],l.type){case WebGLRenderingContext.SAMPLER_CUBE:case WebGLRenderingContext.SAMPLER_2D:var u=this.getEntry(l.value);u&&(l.value=u.entry);break;default:}}}return this._materials||(this._materials=[]),this._materials.push(i),!0}},handleLight:{value:function(){return!0}},handleAccessor:{value:function(e,t){t.id=e;var i=this.getEntry(t.bufferView);t.bufferView=i.entry,t.byteOffset||(t.byteOffset=0),this.storeEntry(e,t,t)}},handleMesh:{value:function(e,t){var i=Object.create(Mesh).init();i.id=e,i.name=t.name;var n=!1,r=t.extensions;r&&(r["won-compression"]&&(n=!0,i.compression=r["won-compression"],i.compression.type="won-compression",i.compression.compressedData.bufferView=this.getEntry(i.compression.compressedData.bufferView).entry,i.compression.compressedData.id=e+"_compressedData"),r["Open3DGC-compression"]&&(n=!0,i.compression=r["Open3DGC-compression"],i.compression.type="Open3DGC-compression",i.compression.compressedData.bufferView=this.getEntry(i.compression.compressedData.bufferView).entry,i.compression.compressedData.id=e+"_compressedData")),this.storeEntry(e,i,t);var a=t[Mesh.PRIMITIVES];if(!a)return console.log("MISSING_PRIMITIVES for mesh:"+e),!1;for(var s=0;a.length>s;s++){var o=a[s];if(o.primitive===WebGLRenderingContext.TRIANGLES){var l=Object.create(Primitive).init(),u=this.getEntry(o.material);l.material=u.entry,i.primitives.push(l);var c=o.attributes,h=Object.keys(c);h.forEach(function(e){var t=c[e],i=this.getEntry(t);l.addVertexAttribute({semantic:e,attribute:i.entry})},this);var d=o.indices,m=this.getEntry(d);l.indices=m.entry}}return!0}},handleCamera:{value:function(e,t){var i=Object.create(Camera).init();i.id=e,this.storeEntry(e,i,t);var n=Object.create(Projection);return n.initWithDescription(t),i.projection=n,!0}},handleLight:{value:function(){return!0}},buildNodeHirerachy:{value:function(e){var t=e.entry,i=e.description.children;i&&i.forEach(function(e){var i=this.getEntry(e),n=i.entry;null==n.parent?t.children.push(n):t.children.push(n.copy()),this.buildNodeHirerachy(i)},this)}},resolveParameterSources:{value:function(){this._materials&&this._materials.forEach(function(e){if(e.parameters){var t=Object.keys(e.parameters);t.forEach(function(t){var i=e.parameters[t];i&&i.source&&(i.source=this.getEntry(i.source).entry)},this)}},this)}},buildSkeletons:{value:function(e){if(e.instanceSkin){var t=e.instanceSkin.skin;if(t){e.instanceSkin.skeletons.forEach(function(e){var i=this.getEntry(e);if(i){var n=i.entry,r=t.jointsIds,a=[];r.forEach(function(t){var i=n.nodeWithJointID(t);i?a.push(i):console.log("WARNING: jointId:"+t+" cannot be found in skeleton:"+e)},this),t.nodesForSkeleton[e]=a}},this);var i=[];e.instanceSkin.sources.forEach(function(e){var t=this.getEntry(e);t&&i.push(t.entry)},this),t.sources=i}}var n=e.children;n&&n.forEach(function(e){this.buildSkeletons(e)},this)}},handleScene:{value:function(e,t){if(this._scenes||(this._scenes=[]),!t.nodes)return console.log("ERROR: invalid file required nodes property is missing from scene"),!1;var i=Object.create(glTFScene).init();i.ids=this._ids,i.id=e,i.name=t.name,i.baseURL=this.baseURL,this.storeEntry(e,i,t);var n=Object.create(glTFNode).initWithID();return t.nodes&&t.nodes.forEach(function(e){var t=this.getEntry(e);n.children.push(t.entry),this.buildNodeHirerachy(t)},this),this.resolveParameterSources(),this.buildSkeletons(n),i.rootNode=n,this._scenes.push(i),!0}},handleSkin:{value:function(e,t){var i=Object.create(Skin).init();i.bindShapeMatrix=mat4.create(t.bindShapeMatrix),i.jointsIds=t.joints,i.inverseBindMatricesDescription=t.inverseBindMatrices,i.inverseBindMatricesDescription.id=e+"_inverseBindMatrices",i.inverseBindMatricesDescription.bufferView=this.getEntry(i.inverseBindMatricesDescription.bufferView).entry,this.storeEntry(e,i,t)}},handleNode:{value:function(e,t){var i=Object.create(glTFNode).init();i.id=e,i.jointId=t.jointId,i.name=t.name,this.storeEntry(e,i,t),i.transform=Object.create(Transform).initWithDescription(t);var n;if(t.mesh&&(n=this.getEntry(t.mesh),i.meshes.push(n.entry)),t.meshes&&t.meshes.forEach(function(e){n=this.getEntry(e),n&&i.meshes.push(n.entry)},this),t.camera){var r=this.getEntry(t.camera);r&&i.cameras.push(r.entry)}if(t.instanceSkin){t.instanceSkin.skin=this.getEntry(t.instanceSkin.skin).entry,i.instanceSkin=t.instanceSkin;var a=i.instanceSkin.sources;a&&a.forEach(function(e){n=this.getEntry(e),n&&i.meshes.push(n.entry)},this)}return!0}},handleLoadCompleted:{value:function(){if(this.delegate){var e=null;if(this._state.options&&(e=this._state.options.ids),e)e.forEach(function(e){var t=this.getEntry(e);t&&this.delegate.loadCompleted(t.entry)},this);else if(this._scenes&&this.delegate&&this._scenes.length>0){var t=Object.create(AnimationManager).init();t.animations=this._animations,this._scenes[0].animationManager=t,this.delegate.loadCompleted(this._scenes[0])}}}},handleAnimation:{value:function(e,t){this._animations||(this._animations=[]);var i=Object.create(KeyframeAnimation).initWithDescription(t);i.id=e,this.storeEntry(e,i,t);var n={};Object.keys(t.parameters).forEach(function(r){var a=t.parameters[r];switch(parameterDescription=this.getEntry(a).entry,parameterDescription.type){case WebGLRenderingContext.FLOAT_VEC4:componentsPerAttribute=4;break;case WebGLRenderingContext.FLOAT_VEC3:componentsPerAttribute=3;break;case WebGLRenderingContext.FLOAT_VEC2:componentsPerAttribute=2;break;case WebGLRenderingContext.FLOAT:componentsPerAttribute=1;break;default:console.log("type:"+parameterDescription.type+" byteStride not handled")}if(parameterDescription.extensions){var s=parameterDescription.extensions;if(s){var o=s["Open3DGC-compression"];if(o){var l=o.compressedData;l&&"object"!=typeof l.bufferView&&(l.bufferView=this.getEntry(l.bufferView).entry,l.id=e+r+"_compressedData")}}}parameterDescription.byteStride=4*componentsPerAttribute,parameterDescription.componentsPerAttribute=componentsPerAttribute,parameterDescription.id=i.id+r,n[r]=parameterDescription},this),i.parameters=n,i.channels.forEach(function(e){var t=e.target.id;e.path=e.target.path,e.target=this.getEntry(t).entry},this),Object.keys(i.samplers).forEach(function(e){var r=t.samplers[e],a=i.samplers[e],s=r.input,o=r.output;a.input=n[s],a.output=n[o]},this),this._animations.push(i)}},handleTexture:{value:function(e,t){if(t.source&&t.sampler)t.type="texture",t.source=this.getEntry(t.source).entry,t.sampler=this.getEntry(t.sampler).entry,t.id=e,this.storeEntry(e,t,t);else if(t.sources&&t.sampler){t.type="texture";for(var i=0;t.sources.length>i;i++)t.sources[i]=this.getEntry(t.sources[i]).entry;t.sampler=this.getEntry(t.sampler).entry,t.id=e,this.storeEntry(e,t,t)}else console.log("ERROR: texture"+e+" must contain both source and sampler properties")}},handleSampler:{value:function(e,t){t.id=t,this.storeEntry(e,t,t)}},handleError:{value:function(){}},_delegate:{value:null,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(e){this._delegate=e}},_entries:{enumerable:!1,value:null,writable:!0},removeAllEntries:{value:function(){this._entries={}}},containsEntry:{enumerable:!1,value:function(e){return this._entries?this._entries[e]?!0:!1:!1}},storeEntry:{enumerable:!1,value:function(e,t,i){return null==this._entries&&(this._entries={}),null==this._ids&&(this._ids={}),t.baseId=e,this._ids[e]=t,(e+=this.loaderContext())?(t.id=e,this.containsEntry[e]&&console.log("WARNING: entry:"+e+" is already stored, overriding"),this._entries[e]={id:e,entry:t,description:i},e):(console.log("ERROR: not id provided, cannot store"),void 0)}},getEntry:{enumerable:!1,value:function(e){return e+=this.loaderContext(),this._entries?this._entries[e]:null}}});