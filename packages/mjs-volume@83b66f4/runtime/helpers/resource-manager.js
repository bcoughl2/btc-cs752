var ContiguousRequests=Object.create(Object,{kind:{value:"multi-parts",writable:!0},range:{value:null,writable:!0},_requests:{value:null,writable:!0},requests:{get:function(){return this._requests},set:function(e){this._requests=e}},canMergeRequest:{value:function(e,t){var n=e.range[1]-e.range[0],i=this.range[1]-this.range[0];return n+i>t?!1:(e.range[0]===this.range[1]||e.range[1]===this.range[0])&&e.type===this.type}},mergeRequest:{value:function(e){0===this.requests.length?(this.requests.push(e),this.range=[e.range[0],e.range[1]]):e.range[0]===this.range[1]?(this.requests.push(e),this.range[1]=e.range[1]):e.range[1]===this.range[0]?(this.requests.unshift(e),this.range[0]=e.range[0]):console.log("ERROR: should not reach")}},mergeRequests:{value:function(e){if(this.range)if(e[0].range[1]<this.range[0])for(var t=e.length-1;t>=0;t--)this.mergeRequest(e[t]);else for(var t=0;e.length>t;t++)this.mergeRequest(e[t]);else e.forEach(function(e){this.mergeRequest(e)},this)}},id:{value:null,writable:!0},initWithRequests:{value:function(e){return this.requests=[],this.mergeRequests(e),this.id=e[0].id,this}}}),RequestTreeNode=Object.create(Object,{_content:{value:null,writable:!0},content:{get:function(){return this._content},set:function(e){this._content=e}},_parent:{value:null,writable:!0},parent:{get:function(){return this._parent},set:function(e){this._parent=e}},_left:{value:null,writable:!0},left:{get:function(){return this._left},set:function(e){this._left=e}},_right:{value:null,writable:!0},right:{get:function(){return this._right},set:function(e){this._right=e}},_checkConsistency:{value:function(e){e.length>=50||(this.left&&this.left._checkConsistency(e),e.push(this.content.range),this.right&&this.right._checkConsistency(e))}},checkConsistency:{value:function(){var e=[];if(this._checkConsistency(e),e.length>1)for(var t=0;e.length-1>t;t++){var n=e[0],i=e[1];n[1]<=i[0]||console("ERROR: INCONSISTENCY CHECK Failed, ranges are not ordered in btree")}}},_collect:{value:function(e,t){this.left&&this.left._collect(e,t),e.length>=t||(e.push(this),this.right&&this.right._collect(e,t))}},collect:{value:function(e){var t=[];return this._collect(t,e),t}},insert:{value:function(e,t){if(e.range[1]<=this.content.range[0]){if(e.range[1]===this.content.range[0])return"multi-parts"===e.kind?this.content.mergeRequests(e.requests):this.content.mergeRequests(e),this.left&&this.content.canMergeRequest(this.left.content,t)&&(this.content.mergeRequests(this.left.content._requests),this.left.remove(this.left.content)),this.parent&&this.parent.content.canMergeRequest(this.content,t)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.left)return this.left.insert(e,t);var n=Object.create(RequestTreeNode);return n.parent=this,n.content=e,this.left=n,n}if(e.range[0]>=this.content.range[1]){if(e.range[0]===this.content.range[1])return"multi-parts"===e.kind?this.content.mergeRequests(e.requests):this.content.mergeRequests(e),this.right&&this.content.canMergeRequest(this.right.content,t)&&(this.content.mergeRequests(this.right.content._requests),this.right.remove(this.right.content)),this.parent&&this.parent.content.canMergeRequest(this.content,t)&&(this.parent.content.mergeRequests(this.content._requests),this.remove(this.content)),null;if(this.right)return this.right.insert(e,t);var n=Object.create(RequestTreeNode);return n.parent=this,n.content=e,this.right=n,n}console.log("ERROR: should not reach")}},contains:{value:function(e){return this.node===e?!0:this.left&&this.left.contains(e)?!0:this.right&&this.right.contains(e)?!0:!1}},min:{value:function(){for(var e=this;e.left;)e=e.left;return e}},_updateParentWithNode:{value:function(e){this.parent&&(this===this.parent.left?this.parent.left=e:this.parent.right=e),e&&(e.parent=this.parent)}},removeMin:{value:function(){this.parent;for(var e=this;e.left||e.right;)e.left&&(e=e.min()),e.right&&(e=e.right.min());return e._updateParentWithNode(null),e}},remove:{value:function(e){if(e.range[1]<=this.content.range[0])this.left.remove(e);else if(e.range[0]>=this.content.range[1])this.right.remove(e);else if(e===this.content)if(this.left&&this.right){var t=this.right.min();this.content=t.content,t._updateParentWithNode(t.right)}else this.left||this.right?this.left?this._updateParentWithNode(this.left):this._updateParentWithNode(this.right):this._updateParentWithNode(null)}}});exports.WebGLTFResourceManager=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},_resources:{value:null,writable:!0},_requestTrees:{value:null,writable:!0},requestTrees:{get:function(){return this._requestTrees}},_resourcesStatus:{value:null,writable:!0},_resourcesBeingProcessedCount:{value:0,writable:!0},_observers:{value:null,writable:!0},_maxConcurrentRequests:{value:1,writable:!0},observers:{get:function(){return this._observers},set:function(e){this._observers=e}},maxConcurrentRequests:{get:function(){return this._maxConcurrentRequests},set:function(e){this._maxConcurrentRequests=e}},reset:{value:function(){if(this._resourcesStatus){var e=Object.keys(this._resourcesStatus);e.forEach(function(e){var t=this._resourcesStatus[e];t&&t.xhr&&t.xhr.abort()},this)}var t=Object.keys(this._resources);t.forEach(function(e){var t=this._resources[e];t&&"VIDEO"===t.nodeName&&t.pause()},this),this._resources={},this._requestTrees={},this._resourcesStatus={},this._resourcesBeingProcessedCount=0,this._wholeBuffers={}}},_bytesLimit:{value:5e5,writable:!0},bytesLimit:{get:function(){return this._bytesLimit},set:function(e){this._bytesLimit!==e&&(this._bytesLimit=e)}},_containsResource:{enumerable:!1,value:function(e){return this._resources[e]?!0:!1}},init:{value:function(){this._requestTrees={},this._resources={},this._resourcesStatus={},this._observers=[],this._resourcesBeingProcessedCount=0}},_storeResource:{enumerable:!1,value:function(e,t){return e?(this._containsResource[e]&&console.log("WARNING: resource:"+e+" is already stored, overriding"),this._resources[e]=t,void 0):(console.log("ERROR: entry does not contain id, cannot store"),void 0)}},_getResource:{enumerable:!1,value:function(e){return this._resources[e]}},_loadResource:{value:function(e,t){var n,i=this,r=e.path;if("multi-parts"===e.kind?(n=e.requests[0].type,r=e.requests[0].path):(n=e.type,r=e.path),!n)return t.handleError(WebGLTFResourceManager.INVALID_TYPE,null),void 0;if(!r)return t.handleError(WebGLTFResourceManager.INVALID_PATH),void 0;var a=new XMLHttpRequest;if(a.open("GET",r,!0),a.responseType=n,e.range){var s="bytes="+e.range[0]+"-"+(e.range[1]-1);a.setRequestHeader("Range",s)}a.onload=function(){200==this.status||206==this.status?(i._resourcesBeingProcessedCount--,"multi-parts"===e.kind?e.requests.forEach(function(n){var r=this.response.slice(n.range[0]-e.range[0],n.range[1]-e.range[0]);t.resourceAvailable(i,n,r)},this):t.resourceAvailable(i,e,this.response)):t.handleError(WebGLTFResourceManager.XMLHTTPREQUEST_STATUS_ERROR,this.status)},a.send(null);var o=this._resourcesStatus[e.id];o&&(o.xhr=a)}},_processNextResource:{value:function(e){if(e){var t=!e.left&&!e.right;if(t)return this._handleRequest(e.content),!1;var n=e.removeMin();this._handleRequest(n.content)}return!0}},_observingEnabled:{value:!1,writable:!0},isObserving:{value:function(){return this._observingEnabled}},startObserving:{value:function(){this._observingEnabled=!0}},stopObserving:{value:function(){this._observingEnabled=!1}},fireResourceAvailable:{value:function(e){this._observingEnabled&&this.observers&&this.observers.forEach(function(t){t.resourceAvailable&&t.resourceAvailable(e)},this)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(e){var t=this._resourcesStatus[e.id],n=null,i=null,r=this.requestTrees?this.requestTrees[e.path]:null;if(t){if("loading"===t.status)return;n=t.node,i=t.status}if("arraybuffer"!==e.type){var a=this,s={};"multi-parts"===e.kind?e.requests.forEach(function(e){this._resourcesStatus[e.id]={status:"loading"}},this):this._resourcesStatus[e.id]={status:"loading"},s.resourceAvailable=function(e,t,n){var i=t.delegate.convert(t,n,t.ctx);if(a._storeResource(t.id,i),t.delegate.resourceAvailable(i,t.ctx),delete a._resourcesStatus[t.id],a.fireResourceAvailable.call(a,t.id),a._resourcesBeingProcessedCount<a.maxConcurrentRequests){var r=e.requestTrees?e.requestTrees[t.path]:null;a._processNextResource(r)||r&&delete e.requestTrees[t.path]}},s.handleError=function(t,n){e.delegate.handleError(t,n)},a._resourcesBeingProcessedCount++,this._loadResource(e,s)}else if(!i){var o,l=null;if(o="multi-parts"===e.kind?Object.create(ContiguousRequests).initWithRequests(e.requests):Object.create(ContiguousRequests).initWithRequests([e]),r)l=r.insert(o,this.bytesLimit);else{var u=Object.create(RequestTreeNode);u.content=o,this._requestTrees[e.path]=u,r=u,l=u}"multi-parts"===e.kind?e.requests.forEach(function(e){this._resourcesStatus[e.id]={status:"queued",node:l}},this):this._resourcesStatus[e.id]={status:"queued",node:l}}}},_elementSizeForGLType:{value:function(e){switch(e){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.FLOAT_VEC2:return 2*Float32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.FLOAT_VEC3:return 3*Float32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.FLOAT_VEC4:return 4*Float32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.FLOAT_MAT4:return 16*Float32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.FLOAT_MAT3:return 9*Float32Array.BYTES_PER_ELEMENT;default:return null}}},_allowRangedRequests:{value:!1,writable:!1},_wholeBuffers:{value:null,writable:!0},_handleWrappedBufferViewResourceLoading:{value:function(e,t,n){var i="arraybuffer",r=e.bufferView;if(r){var a=r.buffer,s=e.byteOffset+r.description.byteOffset,o=[s,this._elementSizeForGLType(e.type)*e.count+s];a.description&&a.description.type&&(i=a.description.type);var l={source:e,id:e.id,range:o,type:i,path:a.description.path,delegate:t,ctx:n,kind:"single-part"}}if(this._allowRangedRequests)this._handleRequest(l,null);else{this._wholeBuffers||(this._wholeBuffers={});var r=e.bufferView;if(r){var u=this,a=r.buffer,c=this._wholeBuffers[a.id];if(null==c){var h={};h.resourceAvailable=function(e,t,n){var i=u._wholeBuffers[t.id];e._storeResource(t.id,n),i.pendingRequests&&(i.pendingRequests.forEach(function(t){delete u._resourcesStatus[t.id];var i=n.slice(t.range[0],t.range[1]),r=t.delegate;if(null==this._resources[t.id]){var a=r.convert(t.source,i,t.ctx);e._storeResource(t.id,a),r.resourceAvailable(a,t.ctx)}u.fireResourceAvailable.call(u,t.id)},u),i.pendingRequests=[])},h.handleError=function(){};var d={id:a.id,type:i,path:a.description.path,delegate:t,ctx:n,kind:"single-part"};u._resourcesBeingProcessedCount++,this._loadResource(d,h),c={activeRequest:"bufferRequest",pendingRequests:[]},this._wholeBuffers[a.id]=c}else{var m=this._getResource(a.id);if(m){var f=m.slice(l.range[0],l.range[1]),t=l.delegate,p=t.convert(e,f,l.ctx);return u._storeResource(l.id,p),t.resourceAvailable(p,l.ctx),u.fireResourceAvailable.call(u,l.id),void 0}}var _=this._resourcesStatus[l.id];if(_&&"loading"===_.status)return;c.pendingRequests.push(l),this._resourcesStatus[l.id]={status:"loading"}}}}},shaderDelegate:{value:{handleError:function(e,t){console.log("ERROR:shaderDelegate:"+e+" :"+t)},convert:function(e,t){return t},resourceAvailable:function(e,t){if(t.sources[t.stage]=e,t.sources["x-shader/x-fragment"]&&t.sources["x-shader/x-vertex"]){var n=t.programCtx.delegate,i=n.convert(null,t.sources,t.programCtx.ctx);t.programCtx.resourceManager._storeResource(t.programCtx.id,i),n.resourceAvailable(i,t.programCtx.ctx),t.programCtx.resourceManager.fireResourceAvailable.call(t.programCtx.resourceManager,t.programCtx.id)}}}},_handleProgramLoading:{value:function(e,t,n){var i={delegate:t,ctx:n,resourceManager:this,id:e.id},r={},a={stage:"x-shader/x-fragment",sources:r,programCtx:i},s={stage:"x-shader/x-vertex",sources:r,programCtx:i};this.getResource(e["x-shader/x-fragment"],this.shaderDelegate,a),this.getResource(e["x-shader/x-vertex"],this.shaderDelegate,s)}},_handleShaderLoading:{value:function(e,t,n){this._handleRequest({id:e.id,type:"text",path:e.description.path,delegate:t,ctx:n,kind:"single-part"},null)}},_handleVideoLoading:{value:function(e,t,n){var i=this._resourcesStatus[e.id];if(!i||"loading"!==i.status){this._resourcesStatus[e.id]={status:"loading"};var r=this;if(e.description.path){this._resourcesBeingProcessedCount++;var a=document.createElement("video");a.preload="auto",a.loop="loop",a.addEventListener("canplaythrough",function(){r._resourcesBeingProcessedCount--,a.play(),delete r._resourcesStatus[e.id],r._storeResource(e.id,a),t(a,e.id,n)}),a.src=e.description.path}}}},_handleImageLoading:{value:function(e,t,n,i){var r=this._resourcesStatus[e.id];if(!r||"loading"!==r.status){this._resourcesStatus[e.id]={status:"loading"};var a=this;if(e.description.path){this._resourcesBeingProcessedCount++;var s=new Image;s.onload=function(){a._resourcesBeingProcessedCount--,delete a._resourcesStatus[e.id],a._storeResource(e.id,s),t(s,e.id,n,i)},s.src=e.description.path}else e.description.image&&t(e.description.image,e.id,n,i)}}},_handleTextureLoading:{value:function(e,t,n){var i=this._resourcesStatus[e.id];if(!i||"loading"!==i.status){this._resourcesStatus[e.id]={status:"loading"};var r=this;if(e.source)"image"===e.source.type&&this._handleImageLoading(e.source,function(n,i,a){var s=t.convert(n,e,a);delete r._resourcesStatus[e.id],r._storeResource(e.id,s),t.resourceAvailable(s,a),r.fireResourceAvailable.call(r,e.id)},n),"video"===e.source.type&&this._handleVideoLoading(e.source,function(n,i,a){var s=t.convert(n,e,a);delete r._resourcesStatus[e.id],r._storeResource(e.id,s),t.resourceAvailable(s,a),r.fireResourceAvailable.call(r,e.id)},n);else if(e.sources){var a=0,s=[null,null,null,null,null,null],o=0;e.sources.forEach(function(i){"image"===i.type&&this._handleImageLoading(i,function(n,i,o,l){if(a++,s[l]=n,a==e.sources.length){var u=t.convert(s,e,o);delete r._resourcesStatus[e.id],r._storeResource(e.id,u),t.resourceAvailable(u,o),r.fireResourceAvailable.call(r,e.id)}},n,o++),"video"===i.type&&this._handleVideoLoading(i,function(n,i,l){if(a++,s[o]=n,a==e.sources.length){var u=t.convert(s,e,l);delete r._resourcesStatus[e.id],r._storeResource(e.id,u),t.resourceAvailable(u,l),r.fireResourceAvailable.call(r,e.id)}},n,o++)},this)}}}},setResource:{value:function(e,t){this._resources[e],this._resources[e]=t}},getResource:{value:function(e,t,n){var i=this._getResource(e.id);return i?i:("program"===e.type?this._handleProgramLoading(e,t,n):"shader"===e.type?this._handleShaderLoading(e,t,n):"image"===e.type?this._handleImageLoading(e,t,n):"texture"===e.type?this._handleTextureLoading(e,t,n):this._handleWrappedBufferViewResourceLoading(e,t,n),null)}},hasPendingRequests:{value:function(){return this._resourcesBeingProcessedCount>0}},removeAllResources:{value:function(){this._resources={}}}});