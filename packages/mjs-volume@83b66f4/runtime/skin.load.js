montageDefine("83b66f4","runtime/skin",{dependencies:["runtime/dependencies/gl-matrix","runtime/base","runtime/transform","runtime/utilities"],factory:function(e,t){e("runtime/dependencies/gl-matrix"),e("runtime/base").Base,e("runtime/transform").Transform,e("runtime/utilities").Utilities,t.Skin=Object.create(Object.prototype,{jointsIds:{value:null,writable:!0},nodesForSkeleton:{value:null,writable:!0},bindShapeMatrix:{value:null,writable:!0},inverseBindMatricesDescription:{value:null,writable:!0},matricesForSkeleton:{value:null,writable:!0},sources:{value:null,writable:!0},init:{value:function(){return this.jointsIds=[],this.nodesForSkeleton={},this.matricesForSkeleton={},this.sources=[],this}},inverseBindMatricesDelegate:{value:{handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t){return new Float32Array(t)},resourceAvailable:function(){}}},process:{value:function(e,t){var n=e.instanceSkin.skeletons,i=mat4.create();mat4.inverse(e.worldMatrix,i),n.forEach(function(e){var n=this.nodesForSkeleton[e],r=this.matricesForSkeleton[e];if(!r){var a=16*this.jointsIds.length;r=new Float32Array(a),this.matricesForSkeleton[e]=r;for(var s=mat4.identity(),o=0;a>o;o++)r[o]=s[o%16]}var l=t.getResource(this.inverseBindMatricesDescription,this.inverseBindMatricesDelegate);l&&this.sources.forEach(function(e){for(var t=e,a=this.bindShapeMatrix,s=this.jointsIds.length,o=mat4.create(),u=0;s>u;u++){for(var c=0;16>c;c++)o[c]=l[16*u+c];var h=n[u].worldMatrix,d=mat4.identity();mat4.multiply(d,i),mat4.multiply(d,h),mat4.multiply(d,o),mat4.multiply(d,a);for(var c=0;16>c;c++)r[16*u+c]=d[c]}t.primitives.forEach(function(e){e.material.parameters&&(e.material.parameters.jointMat.value=r)},this)},this)},this)}}})}});