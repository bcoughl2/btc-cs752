montageDefine("3c07db4","core/document-resources",{dependencies:["./core","./promise","./mini-url"],factory:function(e,t){var r=e("./core").Montage,i=e("./promise").Promise,n=e("./mini-url"),s=r.specialize({_SCRIPT_TIMEOUT:{value:5e3},_document:{value:null},_resources:{value:null},_preloaded:{value:null},_expectedStyles:{value:null},constructor:{value:function s(){this.super(),this._expectedStyles=[]}},initWithDocument:{value:function(e){return this.clear(),this._document=e,this._populateWithDocument(e),this}},_populateWithDocument:{value:function(e){var t=e.querySelectorAll("script"),r=Array.prototype.forEach;r.call(t,function(e){e.src&&this._addResource(this.normalizeUrl(e.src))},this);var i=e.querySelectorAll("link");r.call(i,function(e){"stylesheet"===e.rel&&this._addResource(this.normalizeUrl(e.href))},this)}},clear:{value:function(){this._resources=Object.create(null),this._preloaded=Object.create(null)}},_addResource:{value:function(e){this._resources[e]=!0}},hasResource:{value:function(e){return e in this._resources}},isResourcePreloaded:{value:function(e){return this._preloaded[e]===!0}},isResourcePreloading:{value:function(e){return i.isPromise(this._preloaded[e])}},setResourcePreloadedPromise:{value:function(e,t){this._preloaded[e]=t}},setResourcePreloaded:{value:function(e){this._preloaded[e]=!0}},getResourcePreloadedPromise:{value:function(e){return this._preloaded[e]}},addScript:{value:function(e){var t=this.normalizeUrl(e.src);return t?this.isResourcePreloaded(t)?i.resolve():this.isResourcePreloading(t)?this.getResourcePreloadedPromise(t):this._importScript(e):this._importScript(e)}},_importScript:{value:function(e){var t,r,n=this,s=this._document,a=s.head,o=i.defer(),u=e.src;return u?(n._addResource(u),t=function(){n.setResourcePreloaded(u),e.removeEventListener("load",t),e.removeEventListener("error",t),clearTimeout(r),o.resolve()},e.addEventListener("load",t,!1),e.addEventListener("error",t,!1),r=setTimeout(function(){n.setResourcePreloaded(u),o.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(u,o.promise)):o.resolve(),a.appendChild(s.createComment("Inserted from FIXME")),a.appendChild(e),o.promise}},addStyle:{value:function(e){var t,r=e.getAttribute("href");if(r){if(r=this.normalizeUrl(r),this.hasResource(r))return;this._addResource(r),this._expectedStyles.push(r)}t=this._document.head,t.insertBefore(e,t.firstChild)}},normalizeUrl:{value:function(e,t){return t||(t=this._document.location.href),n.resolve(t,e)}},domain:{value:window.location.protocol+"//"+window.location.host},isCrossDomain:{value:function(e){return 0!==e.indexOf(this.domain+"/")||0===e.indexOf("file://")}},preloadResource:{value:function(e,t){var r;return e=this.normalizeUrl(e),!t&&this.isCrossDomain(e)&&(r=!0),r||this.isResourcePreloaded(e)?i.resolve():this.isResourcePreloading(e)?this.getResourcePreloadedPromise(e):this._preloadResource(e)}},_preloadResource:{value:function(e){var t,r,n=this,s=new XMLHttpRequest,a=i.defer();return s.open("GET",e),t=function(){n.setResourcePreloaded(e),s.removeEventListener("load",t),s.removeEventListener("error",t),clearTimeout(r),a.resolve()},s.addEventListener("load",t,!1),s.addEventListener("error",t,!1),s.send(),r=setTimeout(function(){n.setResourcePreloaded(e),a.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(e,a.promise),a.promise}},areStylesLoaded:{get:function(){var e,t;if(this._expectedStyles.length>0){e=this._document.styleSheets;for(var r,i=0;r=e[i];i++)t=this._expectedStyles.indexOf(r.href),t>=0&&this._expectedStyles.splice(t,1)}return 0===this._expectedStyles.length}}},{getInstanceForDocument:{value:function(e){var t=e.__montage_resources__;return t||(t=e.__montage_resources__=(new s).initWithDocument(e)),t}}});t.DocumentResources=s}});