function getAttributeProperties(e,t){var i=UNDERSCORE+t+ATTRIBUTE_PROPERTIES;return e.hasOwnProperty(i)?e[i]:Object.defineProperty(e,i,{enumerable:!1,configurable:!1,writable:!0,value:Object.create(getAttributeProperties(Object.getPrototypeOf(e),t))})[i]}require("collections/shim"),require("./shim/object"),require("./shim/array"),require("./shim/string"),require("./extras/object"),require("./extras/date"),require("./extras/element"),require("./extras/function"),require("./extras/regexp"),require("./extras/string");var deprecate=require("./deprecate"),ATTRIBUTE_PROPERTIES="AttributeProperties",UNDERSCORE="_",PROTO="__proto__",VALUE="value",ENUMERABLE="enumerable",DISTINCT="distinct",SERIALIZABLE="serializable",MODIFY="modify",ARRAY_PROTOTYPE=Array.prototype,OBJECT_PROTOTYPE=Object.prototype,CONSTRUCTOR_COMPATIBILITY=!0,Montage=exports.Montage=function Montage(){};Montage.deprecate=deprecate.deprecateMethod(Montage,deprecate.deprecateMethod,"Montage.deprecate","deprecate module's deprecateMethod"),Montage.callDeprecatedFunction=deprecate.deprecateMethod(Montage,deprecate.callDeprecatedFunction,"Montage.callDeprecatedFunction","deprecate module's callDeprecatedFunction");var PROTO_IS_SUPPORTED={}.__proto__===Object.prototype,PROTO_PROPERTIES_BLACKLIST={_montage_metadata:1,__state__:1},FUNCTION_PROPERTIES=Object.getOwnPropertyNames(Function);if(Object.defineProperty(Montage,"specialize",{value:function(e,t){var i,r,n,s,a,o,c,u=this,f=this.specialize===void 0;if(e=e||Object.empty,t=t||Object.empty,i=e.constructor&&e.constructor.value?e.constructor.value:e.didCreate&&e.didCreate.value?Montage.deprecate(null,e.didCreate.value,"didCreate","constructor"):function(){return this.superForValue("constructor")()||this},PROTO_IS_SUPPORTED)i.__proto__=u;else{n=Object.getOwnPropertyNames(u);for(var o=0;n.length>o;o++)s=n[o],PROTO_PROPERTIES_BLACKLIST.hasOwnProperty(s)||(a=Object.getOwnPropertyDescriptor(i,s),(!a||a.configurable)&&Montage.defineProperty(i,s,Object.getOwnPropertyDescriptor(u,s)));i.__constructorProto__=u,Montage.defineProperty(i,"isPrototypeOf",{value:function(e){for(;null!==e;){if(Object.getPrototypeOf(e)===this)return!0;e=Object.getPrototypeOf(e)}return!1},enumerable:!1})}if(r=Object.create(this.prototype),f){for(n=Object.getOwnPropertyNames(Montage),o=0;n.length>o;o++)s=n[o],a=Object.getOwnPropertyDescriptor(i,s),(!a||a.configurable)&&Montage.defineProperty(i,s,Object.getOwnPropertyDescriptor(Montage,s));for(n=Object.getOwnPropertyNames(Montage.prototype),o=0;n.length>o;o++)s=n[o],a=Object.getOwnPropertyDescriptor(i,s),(!a||a.configurable)&&Montage.defineProperty(r,s,Object.getOwnPropertyDescriptor(Montage.prototype,s))}if(Montage.defineProperties(r,e),CONSTRUCTOR_COMPATIBILITY){c=function(e,t,i){function r(){return this===t&&deprecate.deprecationWarning(Montage.getInfoForObject(t).objectName+"."+i+" should be moved to constructorProperties",null,3),e.apply(this,arguments)}return r.deprecatedFunction=e,r};for(s in e)FUNCTION_PROPERTIES.has(s)?delete e[s]:(a=e[s],a.value&&"function"==typeof a.value&&!a.value.__isConstructor__?a.value=c(a.value,i,s):(a.get&&(a.get=c(a.get,i,s)),a.set&&(a.set=c(a.set,i,s))));Montage.defineProperties(i,e),Montage.defineProperty(i,"create",{value:function(){return new i},enumerable:!1})}return Montage.defineProperties(i,t),Montage.defineProperty(i,"__isConstructor__",{value:!0,enumerable:!1}),Montage.defineProperty(i,"_superCache",{value:{},enumerable:!1}),i.prototype=r,Montage.defineProperty(r,"constructor",{value:i,enumerable:!1}),i},writable:!0,configurable:!0,enumerable:!1}),!PROTO_IS_SUPPORTED){var originalGetPrototypeOf=Object.getPrototypeOf;Object.getPrototypeOf=function(e){return"function"==typeof e&&e.__constructorProto__?e.__constructorProto__:originalGetPrototypeOf.apply(Object,arguments)}}Object.defineProperty(Montage,"create",{configurable:!0,value:function(e,t){if(void 0!==e&&"object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object prototype may only be an Object or null, not '"+e+"'");if(e=e===void 0?this:e,"function"==typeof e)return t?e.specialize(t):new e;var i=Object.create(e);return t&&Montage.defineProperties(i,t),i}});var extendedPropertyAttributes=[SERIALIZABLE];extendedPropertyAttributes.forEach(function(e){Object.defineProperty(Object.prototype,UNDERSCORE+e+ATTRIBUTE_PROPERTIES,{enumerable:!1,configurable:!1,writable:!0,value:{}})}),Object.defineProperty(Montage,"defineProperty",{value:function(e,t,i){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError("Object must be an object, not '"+e+"'");var r=VALUE in i;if(DISTINCT in i&&!r)throw new TypeError("Cannot use distinct attribute on non-value property '"+t+"'");if(PROTO in i)i.__proto__=r?"function"==typeof i.value?_defaultFunctionValueProperty:_defaultObjectValueProperty:_defaultAccessorProperty;else{var n;n=r?"function"==typeof i.value?_defaultFunctionValueProperty:_defaultObjectValueProperty:_defaultAccessorProperty;for(var s in n)s in i||(i[s]=n[s])}if(i.hasOwnProperty(ENUMERABLE)||t.charAt(0)!==UNDERSCORE||(i.enumerable=!1),i.hasOwnProperty(SERIALIZABLE)||(i.enumerable?i.get&&!i.set?i.serializable=!1:i.writable===!1&&(i.serializable=!1):i.serializable=!1),SERIALIZABLE in i&&(getAttributeProperties(e,SERIALIZABLE)[t]=i.serializable),i.distinct!==!0||"object"!=typeof i.value){var a,o,c;if(e._superDependencies){if("function"==typeof i.value&&(a=e._superDependencies[t+".value"]))for(o=0,c=a.length;c>o;o++)delete a[o]._superCache[t+".value"];if("function"==typeof i.get&&(a=e._superDependencies[t+".get"]))for(o=0,c=a.length;c>o;o++)delete a[o]._superCache[t+".get"];if("function"==typeof i.set&&(a=e._superDependencies[t+".set"]))for(o=0,c=a.length;c>o;o++)delete a[o]._superCache[t+".set"]}return Object.defineProperty(e,t,i)}(function(e,t,i,r){var n=function(e,t,i){Object.defineProperty(e,t,{enumerable:!1,configurable:!0,writable:!0,value:i})};i.constructor===Object&&Object.getPrototypeOf(i)===OBJECT_PROTOTYPE?0!==Object.keys(i).length?Object.defineProperty(r,e,{configurable:!0,get:function(){var e=this[t];if(!e){var r;e={};for(r in i)e[r]=i[r];this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}return e},set:function(e){this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}}):Object.defineProperty(r,e,{configurable:!0,get:function(){var e=this[t];return e||(e={},this.hasOwnProperty(t)?this[t]=e:n(this,t,e)),e},set:function(e){this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}}):(i.__proto__||Object.getPrototypeOf(i))===ARRAY_PROTOTYPE?0!==i.length?Object.defineProperty(r,e,{configurable:!0,get:function(){var e=this[t];if(!e){var r,s;for(e=[],r=0;(s=i[r])!==void 0;r++)e[r]=s;this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}return e},set:function(e){this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}}):Object.defineProperty(r,e,{configurable:!0,get:function(){var e=this[t];return e||(e=[],this.hasOwnProperty(t)?this[t]=e:n(this,t,e)),e},set:function(e){this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}}):i.constructor.prototype===Object.getPrototypeOf(i)?Object.defineProperty(r,e,{configurable:!0,get:function(){var e=this[t];if(!e){var r;e=new i.constructor;for(r in i)e[r]=i[r];this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}return e},set:function(e){this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}}):Object.defineProperty(r,e,{configurable:!0,get:function(){var e=this[t];return e||(e=Object.create(i.__proto__||Object.getPrototypeOf(i)),this.hasOwnProperty(t)?this[t]=e:n(this,t,e)),e},set:function(e){this.hasOwnProperty(t)?this[t]=e:n(this,t,e)}})})(t,UNDERSCORE+t,i.value,e)}}),Object.defineProperty(Montage,"defineProperties",{value:function(e,t){if("object"!=typeof t||null===t)throw new TypeError("Properties must be an object, not '"+t+"'");for(var i in t)"_bindingDescriptors"!==i&&this.defineProperty(e,i,t[i]);return e}});var _defaultAccessorProperty={enumerable:!0,configurable:!0,serializable:!0},_defaultObjectValueProperty={writable:!0,enumerable:!0,configurable:!0,serializable:"reference"},_defaultFunctionValueProperty={writable:!0,enumerable:!1,configurable:!0,serializable:!1};Montage.defineProperty(Montage,"didCreate",{value:Function.noop});var getSuper=function(e,t){var i,r,n,s,a,o,c,u,f;if(!t._superPropertyName||!t._superPropertyType)for(Montage.defineProperty(t,"_superPropertyType",{value:null}),Montage.defineProperty(t,"_superPropertyName",{value:null}),c=e;!u&&null!==c;){for(i=Object.getOwnPropertyNames(c),r=Object.getPrototypeOf(c),n=0,s=i.length,n;s>n;n++){if(a=i[n],f=Object.getOwnPropertyDescriptor(c,a),null!=(o=f.value)&&(o===t||o.deprecatedFunction===t)){t._superPropertyType="value",t._superPropertyName=a,u=!0;break}if(null!=(o=f.get)&&(o===t||o.deprecatedFunction===t)){t._superPropertyType="get",t._superPropertyName=a,u=!0;break}if(null!=(o=f.set)&&(o===t||o.deprecatedFunction===t)){t._superPropertyType="set",t._superPropertyName=a,u=!0;break}}c=r}return superForImplementation(e,t._superPropertyType,t._superPropertyName)},superImplementation=function(){if("function"!=typeof superImplementation.caller)throw new TypeError("Can't get super without caller. Use this.superForValue(methodName) if using strict mode.");var e=getSuper(this,superImplementation.caller);return"function"==typeof e?e.bind(this):Function.noop},superForImplementation=function(e,t,i){var r,n,s,a,o,c=e,u=i+"."+t;if(e._superContext||Montage.defineProperty(e,"_superContext",{value:{}}),e._superContext[u])c=e._superContext[u];else for(c=e;null!==c&&(!c.hasOwnProperty(i)||(s=Object.getOwnPropertyDescriptor(c,i),"function"!=typeof s[t]));)c=Object.getPrototypeOf(c);if(a=c.constructor,a._superCache&&a._superCache[u])return o=function(e,t,i,r){return function(){t._superContext[e]=i;var n=r.apply(t,arguments);return delete t._superContext[e],n}}(u,e,a._superCache[u].owner,a._superCache[u].func);for(n=c;r===void 0&&(n=Object.getPrototypeOf(n));)if(n._superDependencies||Montage.defineProperty(n,"_superDependencies",{value:{}}),n._superDependencies[u]||(n._superDependencies[u]=[]),n._superDependencies[u].push(a),s=Object.getOwnPropertyDescriptor(n,i)){if("function"==typeof s[t]){r=s[t];break}break}return"function"==typeof r?(o=function(e,t,i,r){return function(){t._superContext[e]=i;var n=r.apply(t,arguments);return delete t._superContext[e],n}}(u,e,n,r),a._superCache||Montage.defineProperty(a,"_superCache",{value:{}}),a._superCache[u]={func:r,owner:n},o):Function.noop},superForValueImplementation=function(e){return superForImplementation(this,"value",e)},superForGetImplementation=function(e){return superForImplementation(this,"get",e)},superForSetImplementation=function(e){return superForImplementation(this,"set",e)};Montage.defineProperty(Montage,"super",{get:superImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"super",{get:superImplementation,enumerable:!1}),Montage.defineProperty(Montage,"superForValue",{value:superForValueImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"superForValue",{value:superForValueImplementation,enumerable:!1}),Montage.defineProperty(Montage,"superForGet",{value:superForGetImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"superForGet",{value:superForGetImplementation,enumerable:!1}),Montage.defineProperty(Montage,"superForSet",{value:superForSetImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"superForSet",{value:superForSetImplementation,enumerable:!1}),Montage.defineProperty(Montage,"getSerializablePropertyNames",{value:function(e){var t=[],i=e._serializableAttributeProperties;if(i)for(var r in i)i[r]&&t.push(r);return t}}),Montage.defineProperty(Montage,"getPropertyAttribute",{value:function(e,t,i){var r=UNDERSCORE+i+ATTRIBUTE_PROPERTIES,n=e[r];return n?n[t]:void 0}}),Montage.defineProperty(Montage,"getPropertyAttributes",{value:function(e,t){var i={},r=UNDERSCORE+t+ATTRIBUTE_PROPERTIES,n=e[r];if(n){for(var s in n)i[s]=n[s];return i}}});var _instanceMetadataDescriptor={isInstance:{value:!0}},_functionInstanceMetadataDescriptor={objectName:{value:"Function"},isInstance:{value:!0}};Montage.defineProperty(Montage,"getInfoForObject",{value:function(e){var t,i;if(hasOwnProperty.call(e,"_montage_metadata"))return e._montage_metadata;if(t=e._montage_metadata||e.constructor&&e.constructor._montage_metadata||null,i=e.constructor===Function?_functionInstanceMetadataDescriptor:_instanceMetadataDescriptor,e===Object.prototype)return Object.create(t,i);try{return Object.defineProperty(e,"_montage_metadata",{enumerable:!1,writable:!0,value:Object.create(t,i)})._montage_metadata}catch(r){return e._montage_metadata=Object.create(t,i)}}});var UUID=require("./uuid");"undefined"!=typeof window&&(window.uuid=UUID.generate());var hasOwnProperty=Object.prototype.hasOwnProperty,uuidGetGenerator=function(){var e=UUID.generate(),t=Montage.getInfoForObject(this);try{null!==t&&t.isInstance===!1?(this._uuid=e,Object.defineProperty(this,"uuid",{get:function(){return this.hasOwnProperty("uuid")?this._uuid:uuidGetGenerator.call(this)}})):(t.isInstance&&Object.defineProperty(this,"uuid",{configurable:!0,enumerable:!1,writable:!1,value:e}),!(this instanceof Element)&&t.isInstance&&VALUE in(Object.getOwnPropertyDescriptor(this,"uuid")||{})&&PROTO in this||(this._uuid=e))}catch(i){}return this._uuid=e,e},defaultUuidGet=function defaultUuidGet(){return hasOwnProperty.call(this,"_uuid")?this._uuid:uuidGetGenerator.call(this)};Object.defineProperty(Object.prototype,"_uuid",{enumerable:!1,value:null,writable:!0}),Object.defineProperty(Object.prototype,"uuid",{configurable:!0,get:defaultUuidGet,set:function(){}}),Montage.defineProperty(Montage,"identifier",{value:null,serializable:!0}),Montage.defineProperty(Montage.prototype,"identifier",{value:null,serializable:!0}),Montage.defineProperty(Montage.prototype,"equals",{value:function(e){return e?this===e||this.uuid===e.uuid:!1}}),Montage.defineProperty(Montage,"equals",{value:Montage.prototype.equals}),Montage.defineProperty(Montage.prototype,"callDelegateMethod",{value:function(e){var t,i,r=this.delegate;return"string"==typeof this.identifier&&(t=this.identifier+e.toCapitalized(),r&&"function"==typeof(i=r[t]))?(ARRAY_PROTOTYPE.shift.call(arguments),i.apply(r,arguments)):r&&"function"==typeof(i=r[e])?(ARRAY_PROTOTYPE.shift.call(arguments),i.apply(r,arguments)):void 0}});var PropertyChanges=require("collections/listen/property-changes");Object.addEach(Montage,PropertyChanges.prototype),Object.addEach(Montage.prototype,PropertyChanges.prototype);var Bindings=exports.Bindings=require("frb"),bindingPropertyDescriptors={defineBinding:{value:function(e,t,i){return Bindings.defineBinding(this,e,t,i)}},defineBindings:{value:function(e,t){return Bindings.defineBindings(this,e,t)}},cancelBinding:{value:function(e){return Bindings.cancelBinding(this,e)}},cancelBindings:{value:function(){return Bindings.cancelBindings(this)}},getBinding:{value:function(e){return Bindings.getBinding(this,e)}},getBindings:{value:function(){return Bindings.getBindings(this)}}};Montage.defineProperties(Montage,bindingPropertyDescriptors),Montage.defineProperties(Montage.prototype,bindingPropertyDescriptors);var WeakMap=require("collections/weak-map"),Map=require("collections/map"),parse=require("frb/parse"),evaluate=require("frb/evaluate"),assign=require("frb/assign"),observe=require("frb/observe"),bind=require("frb/bind"),compileObserver=require("frb/compile-observer"),Scope=require("frb/scope"),Observers=require("frb/observers"),autoCancelPrevious=Observers.autoCancelPrevious,pathChangeDescriptors=new WeakMap,pathPropertyDescriptors={getPath:{value:function(e,t,i,r){return evaluate(e,this,t||this,i,r)}},setPath:{value:function(e,t,i,r,n){return assign(this,e,t,i||this,r,n)}},observePath:{value:function(e,t){var i=parse(e),r=compileObserver(i);return r(autoCancelPrevious(t),new Scope(this))}},addRangeAtPathChangeListener:{value:function(e,t,i,r,n,s){function a(e,r,n){if(t[i])t[i](e,r,n);else{if(!t.call)throw Error("Can't dispatch range change to "+t);t.call(null,e,r,n)}}i=i||"handleRangeChange";var o=[];return this.addPathChangeListener(e,function(e){return e&&e.toArray&&e.addRangeChangeListener?(a(e.toArray(),o.toArray(),0),o=e,e.addRangeChangeListener(a)):(e=[],a(e,o,0),o=e,void 0)},void 0,void 0,r,n,s)}},getPathChangeDescriptors:{value:function(){return pathChangeDescriptors.has(this)||pathChangeDescriptors.set(this,{}),pathChangeDescriptors.get(this)}},getPathChangeDescriptor:{value:function(e,t,i){var r=Montage.getPathChangeDescriptors.call(this);return Object.owns(r,e)||(r[e]={willChangeListeners:new Map,changeListeners:new Map}),r=r[e],r=i?r.willChangeListeners:r.changeListeners,r.has(t)||r.set(t,{path:e,handler:t,beforeChange:i,cancel:Function.noop}),r.get(t)}},addPathChangeListener:{value:function(e,t,i,r,n,s,a){var o=this;t=t||Function.noop;var c=Montage.getPathChangeDescriptor.call(this,e,t,r);c.cancel();var u,f,l,m=parse(e);if(t===Function.noop)l=function(t){if(f)throw Error("Path change handler needs a handler because it emits new values when the source changes: "+JSON.stringify(e));f=!0,u=t};else if(i)l=function(r){return t[i].call(t,r,e,o)};else if(t.handlePathChange)l=function(i){return t.handlePathChange.call(t,i,e,o)};else{if("function"!=typeof t)throw Error("Can't recognize handler type: "+t+". Must be function or delegate implementing handlePathChange.");l=function(i){return t.call(o,i,e,o)}}var h=compileObserver(m),d=new Scope(this);d.beforeChange=r,d.parameters=n,d.document=s,d.components=a;var p=h(autoCancelPrevious(l),d);return c.cancel=p,f?u:p}},removePathChangeListener:{value:function(e,t,i){t=t||Function.noop;var r=Montage.getPathChangeDescriptors.call(this),n=i?"willChangeListeners":"changeListeners";if(!Object.owns(r,e))throw Error("Can't find "+n+" for "+JSON.stringify(e));var s=r[e],a=s[n];if(!a.has(t))throw Error("Can't find "+n+" for "+JSON.stringify(e));var o=a.get(t);o.cancel(),a["delete"](t),0===s.willChangeListeners.length&&0===s.changeListeners.length&&delete r[e];for(var c in r)return;pathChangeDescriptors["delete"](this)}},addBeforePathChangeListener:{value:function(e,t,i,r,n,s){return Montage.addPathChangeListener.call(this,e,t,i,!0,r,n,s)}},removeBeforePathChangeListener:{value:function(e,t){return Montage.removePathChangeListener.call(this,e,t,!0)}}};Montage.defineProperties(Montage,pathPropertyDescriptors),Montage.defineProperties(Montage.prototype,pathPropertyDescriptors),require("./serialization/bindings"),exports._blueprintModuleIdDescriptor={serializable:!1,enumerable:!1,get:function(){var e=Montage.getInfoForObject(this),t=e&&!e.isInstance?this:this.constructor;if(!Object.getOwnPropertyDescriptor(t,"_blueprintModuleId")||!t._blueprintModuleId){e=Montage.getInfoForObject(t);var i=e.moduleId,r=i.lastIndexOf("/"),n=i.lastIndexOf(".");r=-1===r?0:r+1,n=-1===n?i.length:n,n=r>n?i.length:n,Montage.defineProperty(t,"_blueprintModuleId",{enumerable:!1,value:i.slice(0,n)+".meta"})}return t._blueprintModuleId}},exports._blueprintDescriptor={serializable:!1,enumerable:!1,get:function(){var e=Montage.getInfoForObject(this),t=e&&!e.isInstance?this:this.constructor;if(!Object.getOwnPropertyDescriptor(t,"_blueprint")||!t._blueprint){var i=t.blueprintModuleId;if(""===i)throw new TypeError("Blueprint moduleId undefined for the module '"+JSON.stringify(t)+"'");exports._blueprintDescriptor.BlueprintModulePromise||(exports._blueprintDescriptor.BlueprintModulePromise=require.async("core/meta/module-blueprint").get("ModuleBlueprint")),Montage.defineProperty(t,"_blueprint",{enumerable:!1,value:exports._blueprintDescriptor.BlueprintModulePromise.then(function(e){var r=Montage.getInfoForObject(t);return e.getBlueprintWithModuleId(i,r.require).fail(function(i){if(-1!==i.message.indexOf("Can't XHR"))return e.createDefaultBlueprintForObject(t).then(function(e){return e});throw i})})})}return t._blueprint},set:function(e){var t,i=Montage.getInfoForObject(this),r=i&&!i.isInstance?this:this.constructor;if(null===e)t=null;else{if("function"==typeof e.then)throw new TypeError("Object blueprint should not be a promise");e.blueprintInstanceModule=r.blueprintModule,t=require("./promise").Promise.resolve(e)}Montage.defineProperty(r,"_blueprint",{enumerable:!1,value:t})}};