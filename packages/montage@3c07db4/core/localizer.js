var Montage=require("./core").Montage,MessageFormat=require("./messageformat"),logger=require("./logger").logger("localizer"),Serializer=require("./serialization").Serializer,Deserializer=require("./serialization").Deserializer,Promise=require("./promise").Promise,Bindings=require("./bindings").Bindings,PropertyChanges=require("collections/listen/property-changes"),FrbBindings=require("frb/bindings"),stringify=require("frb/stringify"),expand=require("frb/expand"),Scope=require("frb/scope");MessageFormat.locale=require("./messageformat-locale");var KEY_KEY="key",DEFAULT_MESSAGE_KEY="default",LOCALE_STORAGE_KEY="montage_locale",LOCALES_DIRECTORY="locale",MESSAGES_FILENAME="messages",MANIFEST_FILENAME="manifest.json",EMPTY_STRING_FUNCTION=function(){return""},reLanguageTagValidator=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,Localizer=exports.Localizer=Montage.specialize({constructor:{value:function Localizer(){this.super()}},init:{value:function(e){return this.locale=e||defaultLocalizer.locale,this}},initWithMessages:{value:function(e,t){return this.locale=e,this.messages=t,this}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(e){if(this._messages!==e){if(null!=e&&"object"!=typeof e)throw new TypeError(e," is not an object");this._messages=e}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(e){if(!reLanguageTagValidator.test(e))throw new TypeError("Language tag '"+e+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");this._locale!==e&&(this._locale=e,this.messageFormat=new MessageFormat(e))}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this._manifest.get("files").get(LOCALES_DIRECTORY).get("files").then(function(e){return Object.keys(e)})}},_require:{value:"undefined"!=typeof global?global.require:"undefined"!=typeof window?window.require:null},require:{serializable:!1,get:function(){return this._require},set:function(e){this._require!==e&&(this.__manifest=null,this._require=e)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var e=this.require;return e.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=e.async(MANIFEST_FILENAME):Promise.reject(Error("Package has no manifest. "+e.location+'package.json must contain "manifest": true and '+e.location+MANIFEST_FILENAME+" must exist"))}},loadMessages:{value:function(e,t){if(!this.require)throw Error("Cannot load messages as",this,"require is not set");null===e&&(e=5e3),this.messages=null;var i=this;this.require;var n=this._manifest;return e&&(n=n.timeout(e)),this.messagesPromise=n.get("files").then(function(e){return i._loadMessageFiles(e)}).then(function(e){return i._collapseMessages(e)}).fail(function(e){throw console.error("Could not load messages for '"+i.locale+"': "+e),e}).then(function(e){return"function"==typeof t&&t(e),e})}},_loadMessageFiles:{value:function(e){var t=this.require;if(!e)return Promise.reject(Error(t.location+MANIFEST_FILENAME+" does not contain a 'files' property"));var i,n,r,a,s=[];if(!(LOCALES_DIRECTORY in e))return Promise.reject(Error("Package does not contain a '"+LOCALES_DIRECTORY+"' directory"));for(i=e[LOCALES_DIRECTORY].files,n=this._locale;""!==n;)i.hasOwnProperty(n)&&(r=i[n].files,(a=MESSAGES_FILENAME+".js")in r||(a=MESSAGES_FILENAME+".json")in r?s.push(t.async(LOCALES_DIRECTORY+"/"+n+"/"+a)):logger.isDebug&&logger.debug(this,"Warning: '"+LOCALES_DIRECTORY+"/"+n+"/' does not contain '"+MESSAGES_FILENAME+".json' or '"+MESSAGES_FILENAME+".js'")),n=n.substring(0,n.lastIndexOf("-"));if(!s.length)return Promise.reject(Error("Could not find any "+MESSAGES_FILENAME+".json or "+MESSAGES_FILENAME+".js files"));var o=Promise.all(s);if(logger.isDebug){var u=this;o=o.then(function(e){return logger.debug(u,"loaded "+e.length+" message files"),e})}return o}},_collapseMessages:{value:function(e){for(var t={},i=0,n=e.length;n>i;i++){var r=e[i];for(var a in r)a in t||(t[a]=r[a])}return this.messages=t,t}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(e,t){var i,n,r;if(!e&&!t)throw Error("Key or default message must be truthy, not "+e+" and "+t);if(this._messages&&e in this._messages){if(i=this._messages[e],n=typeof i,"function"===n)return i;if("object"===n){if(!("message"in i))throw Error(i,"does not contain a 'message' property");i=i.message}}else i=t;if(i||(console.warn("No message or default message for key '"+e+"'"),i=e),i in this._compiledMessageCache)return this._compiledMessageCache[i];var a=this.messageFormat.parse(i);return a.program&&a.program.statements&&1===a.program.statements.length&&"string"===a.program.statements[0].type?(r=function(){return i},r.toString=r):r=Function("MessageFormat","return "+this.messageFormat.precompile(a))(MessageFormat),this._compiledMessageCache[i]=r,r}},localize:{value:function(e,t,i,n){var r,a=this;if(i=i===void 0?!0:i,!this.messagesPromise)return r=Promise.resolve(this.localizeSync(e,t)),r.then(n),r;var s=function(){var i=a.localizeSync(e,t);return"function"==typeof n&&n(i),i};return i?this.messagesPromise.then(s,s):this.messagesPromise.then(s)}}}),DefaultLocalizer=Localizer.specialize({init:{value:function(){var e=this.callDelegateMethod("getDefaultLocale");return e||"undefined"==typeof window||(window.localStorage&&(e=window.localStorage.getItem(LOCALE_STORAGE_KEY)),e=e||window.navigator.userLanguage||window.navigator.language),e=e||"en",this.locale=e,this.loadMessages().done(),this}},_delegate:{value:null},delegate:{get:function(){return this._delegate},set:function(e){this._delegate!==e&&(this._delegate=e,this.init())}},locale:{get:function(){return this._locale},set:function(e){try{Object.getPropertyDescriptor(Localizer,"locale").set.call(this,e)}catch(t){e="en",Object.getPropertyDescriptor(Localizer,"locale").set.call(this,e)}"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem(LOCALE_STORAGE_KEY,e)}},reset:{value:function(){return"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(LOCALE_STORAGE_KEY),this.init(),this._locale}}}),defaultLocalizer=exports.defaultLocalizer=(new DefaultLocalizer).init();exports.localize=defaultLocalizer.localize.bind(defaultLocalizer);var Message=exports.Message=Montage.specialize({constructor:{value:function(){this.defineBinding("_data",{"<-":"_dataObject.toMap()"}),this._data.addMapChangeListener(this,"data")}},init:{value:function(e,t,i){return e&&(this.key=e),t&&(this.defaultMessage=t),i&&(this.data=i),this}},_localizer:{value:defaultLocalizer},localizer:{get:function(){return this._localizer},set:function(e){this._localizer!=e&&(this._localizer=e,this._localize())}},_key:{value:null},key:{get:function(){return this._key},set:function(e){this._key!==e&&(this._key=e,this._localize())}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(e){this._defaultMessage!==e&&(this._defaultMessage=e,this._localize())}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(!this._isLocalizeQueued){this._isLocalizeQueued=!0;var e=this,t=Promise.defer();this._messageFunction=t.promise,this.localized=this._messageFunction.then(function(t){return t(e._data.toObject())}),Promise.nextTick(function(){return e._isLocalizeQueued=!1,e._key||e._defaultMessage?(t.resolve(e._localizer.localize(e._key,e._defaultMessage)),void 0):(console.warn("Both key and default message are falsey for",e,"If this is in a repetition this warning can be ignored"),t.resolve(EMPTY_STRING_FUNCTION),void 0)})}}},_messageFunction:{value:Promise.resolve(EMPTY_STRING_FUNCTION)},_dataObject:{value:null},_data:{value:null},data:{get:function(){return this._data},set:function(e){this._dataObject!==e&&(this._dataObject=e)}},__localizedResolved:{value:""},_localizedDeferred:{value:Promise.defer()},localized:{get:function(){return this._localizedDeferred.promise},set:function(e){if(e!==this._localized){var t=this,i=Promise.defer();this._localizedDeferred.resolve(i.promise),e.then(i.resolve,i.reject),i.promise.then(function(e){return t.__localizedResolved=e}).done(),this._localizedDeferred=i}}},handleDataMapChange:{value:function(){this.localized=this._messageFunction.fcall(this._data.toObject())}},serializeSelf:{value:function(){var e={_bindingDescriptors:this._bindingDescriptors};return e.key=this._key,e.defaultMessage=this._defaultMessage,this._localizer!==defaultLocalizer&&(e.localizer=this._localizer),e}},serializeForLocalizations:{value:function(e){var t,i,n={};i=FrbBindings.getBindings(this),i&&i.key?(n[KEY_KEY]={},this._serializeBinding(this,n[KEY_KEY],i.key,e)):n[KEY_KEY]=this._key,i&&i.defaultMessage?(n[DEFAULT_MESSAGE_KEY]={},this._serializeBinding(this,n[DEFAULT_MESSAGE_KEY],i.defaultMessage,e)):n[DEFAULT_MESSAGE_KEY]=this._defaultMessage;var r=FrbBindings.getBindings(this._data);t=this._data.toObject();for(var a in t)!t.hasOwnProperty(a)||r&&r[".get('"+a+"')"]||(n.data||(n.data={}),n.data[a]=t[a]);for(var s in r){var o=/\.get\('([^']+)'\)/.exec(s)[1];n.data||(n.data={}),n.data[o]={},this._serializeBinding(this._data,n.data[o],r[s],e)}return n}},_serializeBinding:{value:function(e,t,i,n){if(!("serializable"in i)||i.serializable){var r=i.sourceSyntax;if(i.source!==e){var a=n.addObjectReference(i.source),s=new Scope({type:"component",label:a["@"]});s.components=n,r=expand(r,s)}var s=new Scope;s.components=n;var o=stringify(r,s);i.twoWay?t["<->"]=o:t["<-"]=o,i.converter?t.converter=i.converter:(t.convert=i.convert,t.revert=i.revert),i.trace&&(t.trace=!0)}}}}),createMessageBinding=function(e,t,i,n,r,a){var s=new Message;for(var o in r)"string"==typeof r[o]?s.data.set(o,r[o]):Bindings.defineBinding(s.data,".get('"+o+"')",r[o],{components:a});"object"==typeof i?Bindings.defineBinding(s,"key",i,{components:a}):s.key=i,"object"==typeof n?Bindings.defineBinding(s,"defaultMessage",n,{components:a}):s.defaultMessage=n,Bindings.defineBinding(e,t,{"<-":"__localizedResolved",source:s,serializable:!1})};Serializer.defineSerializationUnit("localizations",function(e,t){var i=FrbBindings.getBindings(t);if(i){var n;for(var r in i){var a=i[r];if(Message.prototype.isPrototypeOf(a.source)){n||(n={});var s=a.source;n[r]=s.serializeForLocalizations(e)}}return n}}),Deserializer.defineDeserializationUnit("localizations",function(e,t,i){for(var n in i){var r,a,s=i[n];KEY_KEY in s?(!logger.isDebug||DEFAULT_MESSAGE_KEY in s||logger.debug(this,"Warning: localized property '"+n+"' does not contain a default message property ("+DEFAULT_MESSAGE_KEY+"), in ",t),r=s[KEY_KEY],a=s[DEFAULT_MESSAGE_KEY],createMessageBinding(t,n,r,a,s.data,e)):console.error("localized property '"+n+"' must contain a key property ("+KEY_KEY+"), in ",i[n])}});