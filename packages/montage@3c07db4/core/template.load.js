montageDefine("3c07db4","core/template",{dependencies:["./core","./serialization","./document-part","./document-resources","./serialization/serialization","./serialization/serializer/montage-labeler","./promise","./mini-url","./logger","./event/event-manager","./application"],factory:function(e,t){function r(e,t,r){var i,n,a=new d,o=e.documentElement.outerHTML,l=new s,u=e.documentElement;return i=a.createHtmlDocumentWithHtml(o,e.location.href),a.initWithDocument(i,t).then(function(){return a.setBaseUrl(e.location.href),n=a._createTemplateObjects(r),l.initWithTemplateAndFragment(a),a._instantiateObjects(n,u).then(function(e){return l.objects=e,a._invokeDelegates(l),l})})}var i,n=e("./core").Montage,a=e("./serialization").Deserializer,s=e("./document-part").DocumentPart,o=e("./document-resources").DocumentResources,l=e("./serialization/serialization").Serialization,u=e("./serialization/serializer/montage-labeler").MontageLabeler,c=e("./promise").Promise,f=e("./mini-url");e("./logger").logger("template"),e("./event/event-manager").defaultEventManager;var d=n.specialize({_SERIALIZATON_SCRIPT_TYPE:{value:"text/montage-serialization"},_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},PARAM_ATTRIBUTE:{value:"data-param"},_require:{value:null},_resources:{value:null},_baseUrl:{value:null},_instances:{value:null},_metadata:{value:null},_objectsString:{value:null},objectsString:{get:function(){return this._objectsString},set:function(e){this._objectsString=e,this._serialization&&this._serialization.initWithString(e),this.__deserializer=null}},__deserializer:{value:null},_deserializer:{get:function(){var e,t,r=this.__deserializer;if(!r){if(e=this._metadata){t=Object.create(null);for(var i in e)t[i]=e[i].require}r=(new a).init(this.objectsString,this._require,t),this.__deserializer=r}return r}},getDeserializer:{value:function(){return this._deserializer}},_serialization:{value:null},getSerialization:{value:function(){var e=this._serialization;return e||(e=this._serialization=new l,e.initWithString(this.objectsString)),e}},_isDirty:{value:!1},isDirty:{get:function(){return this._isDirty},set:function(e){this._isDirty!==e&&(this._isDirty=e,this.clearTemplateFromElementContentsCache())}},refresher:{value:null},_document:{value:null},document:{get:function(){return this._isDirty&&this.refresh(),this._document},set:function(e){this._document=e}},constructor:{value:function d(){this.super()}},initWithRequire:{value:function(e){return this._require=e,this.document=this.createHtmlDocumentWithHtml(""),this.objectsString="",this}},initWithDocument:{value:function(e,t){var r=this;return this._require=t,this.setDocument(e),this.getObjectsString(e).then(function(e){return r.objectsString=e,r})}},initWithHtml:{value:function(e,t){var r=this;return this._require=t,this.document=this.createHtmlDocumentWithHtml(e),this.getObjectsString(this.document).then(function(e){return r.objectsString=e,r})}},initWithObjectsAndDocumentFragment:{value:function(e,t,r){return this._require=r,this.document=this.createHtmlDocumentWithHtml(""),this.document.body.appendChild(this.document.importNode(t,!0)),this.setObjects(e),this}},initWithModuleId:{value:function(e,t){var r=this;return this._require=t,this.createHtmlDocumentWithModuleId(e,t).then(function(i){var n=t(e).directory;return r.document=i,r.setBaseUrl(n),r.getObjectsString(i).then(function(e){return r.objectsString=e,r})})}},clone:{value:function(){var e=new d;return e._require=this._require,e._baseUrl=this._baseUrl,e.setDocument(this.document),e.objectsString=this.objectsString,e._instances=Object.clone(this._instances,1),e}},instantiate:{value:function(e){return this.instantiateWithInstances(null,e)}},instantiateWithInstances:{value:function(e,t){var r,i,n,a=this,o=new s;return e=e||this._instances,r=this._createMarkupDocumentFragment(t),n=this._getParameters(r),o.initWithTemplateAndFragment(this,r),o.startActingAsTopComponent(),o.parameters=n,i=this._createTemplateObjects(e),this._instantiateObjects(i,r).then(function(r){var i;return o.objects=r,a._invokeDelegates(o,e),o.stopActingAsTopComponent(),i=a.getResources(),!i.resourcesLoaded()&&i.hasResources()&&i.loadResources(t).done(),o})}},_objectsInstantiationOptimized:{value:!1},_optimizeObjectsInstantiationPromise:{value:null},_optimizeObjectsInstantiation:{value:function(){var e,t=this;return this._objectsInstantiationOptimized?void 0:(this._optimizeObjectsInstantiationPromise||(e=this._deserializer.preloadModules(),e?this._optimizeObjectsInstantiationPromise=e.then(function(){t._objectsInstantiationOptimized=!0}):this._objectsInstantiationOptimized=!0),this._optimizeObjectsInstantiationPromise)}},setBaseUrl:{value:function(e){this._baseUrl=e}},getBaseUrl:{value:function(){return this._baseUrl}},getResources:{value:function(){var e=this._resources;return e||(e=this._resources=new h,e.initWithTemplate(this)),e}},_createTemplateObjects:{value:function(t){var r=Object.create(t||null);return i===void 0&&(i=e("./application").application),r.application=i,r.template=this,r}},_instantiateObjects:{value:function(e,t){var r,i=this._deserializer;return r=this._optimizeObjectsInstantiation(),r?r.then(function(){return i.deserialize(e,t)}):i.deserialize(e,t)}},_createMarkupDocumentFragment:{value:function(e){for(var t=e.createDocumentFragment(),r=this.document.body.childNodes,i=0,n=r.length;n>i;i++)t.appendChild(e.importNode(r[i],!0));return t}},getParameterName:{value:function(e){return e.getAttribute(this.PARAM_ATTRIBUTE)}},getParameters:{value:function(){return this._getParameters(this.document.body)}},_getParameters:{value:function(e){for(var t,r=e.querySelectorAll("*["+this.PARAM_ATTRIBUTE+"]"),i=r.length,n={},a=0;i>a;a++){t=r[a];var s=this.getParameterName(t);if(s in n)throw Error('The parameter "'+s+'" is'+" declared more than once in "+this.getBaseUrl()+".");n[s]=t}if("*"in n&&i>1)throw Error('The star "*" template parameter was declared when other parameters were also present in '+this.getBaseUrl()+": "+Object.keys(n)+".");return n}},hasParameters:{value:function(){return!!this.document.querySelector("*["+this.PARAM_ATTRIBUTE+"]")}},_invokeDelegates:{value:function(e,t){var r,i,n,a=e.objects,s=a.owner||t&&t.owner;for(var o in a)t&&o in t||(r=a[o],i=this._getObjectOwner(o,s),n=this._getObjectLabel(o),r&&("function"==typeof r._deserializedFromTemplate&&r._deserializedFromTemplate(i,n,e),"function"==typeof r.deserializedFromTemplate&&r.deserializedFromTemplate(i,n,e)));if(s){var l=this.getSerialization();l.isExternalObject("owner")||("function"==typeof s._templateDidLoad&&s._templateDidLoad(e),"function"==typeof s.templateDidLoad&&s.templateDidLoad(e))}}},setInstances:{value:function(e){this._instances=e}},getInstances:{value:function(){return this._instances}},setObjects:{value:function(e){this.objectsString=JSON.stringify(e,null,4)}},setObjectMetadata:{value:function(e,t,r,i){var n=this._metadata;n||(this._metadata=n=Object.create(null)),n[e]={require:t,label:r,owner:i},this.__deserializer=null}},getObjectMetadata:{value:function(e){var t=this._metadata;return t&&e in t?t[e]:{require:this._require,label:e}}},_getObjectOwner:{value:function(e,t){var r,i=this._metadata;return r=i&&e in i?i[e].owner:t}},_getObjectLabel:{value:function(e){var t,r=this._metadata;return t=r&&e in r?r[e].label:e}},setDocument:{value:function(e){var t=e.documentElement.innerHTML;this.document=this.createHtmlDocumentWithHtml(t,e.baseURI),this.clearTemplateFromElementContentsCache()}},getObjectsString:{value:function(e){var t;return t=this.getInlineObjectsString(e),null===t?this.getExternalObjectsString(e):c.resolve(t)}},getInlineObjectsString:{value:function(e){var t="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"']",r=e.querySelector(t);return r?r.textContent:null}},getExternalObjectsString:{value:function(e){var t,r,i,n=e.querySelector('link[rel="serialization"]');return n?(t=new XMLHttpRequest,r=n.getAttribute("href"),i=c.defer(),t.open("GET",r),t.addEventListener("load",function(){200==t.status?i.resolve(t.responseText):i.reject(Error("Unable to retrive '"+r+"', code status: "+t.status))},!1),t.addEventListener("error",function(e){i.reject(Error("Unable to retrive '"+r+"' with error: "+e.error+"."))},!1),t.send(),i.promise):c.resolve(null)}},createHtmlDocumentWithHtml:{value:function(e,t){var r=document.implementation.createHTMLDocument("");return r.documentElement.innerHTML=e,this.normalizeRelativeUrls(r,t),r}},createHtmlDocumentWithModuleId:{value:function(e,t){var r=this;return"function"!=typeof t?c.reject(Error("Missing 'require' function to load module '"+e+"'.")):t.async(e).then(function(e){return r.createHtmlDocumentWithHtml(e.content,e.directory)})}},_removeObjects:{value:function(e){var t="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"'], link[rel='serialization']";Array.prototype.forEach.call(e.querySelectorAll(t),function(e){e.parentNode.removeChild(e)})}},_addObjects:{value:function(e,t){if(t){var r=e.createElement("script");r.setAttribute("type",this._SERIALIZATON_SCRIPT_TYPE),r.textContent=JSON.stringify(JSON.parse(t),null,4),e.head.appendChild(r)}}},_templateFromElementContentsCache:{value:null},clearTemplateFromElementContentsCache:{value:function(){this._templateFromElementContentsCache=null}},createTemplateFromElementContents:{value:function(e){var t,r,i,n=this._templateFromElementContentsCache;return n||(n=Object.create(null),this._templateFromElementContentsCache=n),e in n?Object.create(n[e]):(t=this.getElementById(e),i=this.document.createRange(),i.selectNodeContents(t),r=this.createTemplateFromRange(i),n[e]=r,Object.create(r))}},createTemplateFromElement:{value:function(e){var t,r;return t=this.getElementById(e),r=this.document.createRange(),r.selectNode(t),this.createTemplateFromRange(r)}},createTemplateFromRange:{value:function(e){var t,r,i,n,a,s=new l;return t=e.cloneContents(),r=this._getChildrenElementIds(t),s.initWithString(this.objectsString),i=s.getSerializationLabelsWithElements(r),a=s.extractSerialization(i,["owner"]),n=new d,n.initWithObjectsAndDocumentFragment(null,t,this._require),n.objectsString=a.getSerializationString(),n._resources=this.getResources(),n}},_createSerializationWithElementIds:{value:function(e){var t,r,i=new l;return i.initWithString(this.objectsString),t=i.getSerializationLabelsWithElements(e),r=i.extractSerialization(t,["owner"])}},expandParameters:{value:function(e){var t,r,i,n,a,s,o,l=[],u={},c=this.getSerialization(),f={};t=this.getParameters();for(var d in t)if(n=t[d],a=e.getTemplateArgumentElement(d),l.push.apply(l,this._getElementIds(a)),r=this.replaceNode(a,n))for(var h in r)u[h]=r[h];return f.elementIds=l,f.elementIdsCollisions=u,s=e.getTemplateArgumentSerialization(l),s.renameElementReferences(u),o=function(t){return t.indexOf(":")>0?e.resolveTemplateArgumentTemplateProperty(t):void 0},i=c.mergeSerialization(s,{willMergeObjectWithLabel:o}),this.objectsString=c.getSerializationString(),f.labels=s.getSerializationLabels(),f.labelsCollisions=i,f}},_resolveElementIdCollisions:{value:function(e,t){var r,i,n,a,s;t=t||new u,n=this.getElementIds();for(var o,l=0;o=n[l];l++)t.addLabel(o);i=this._getElements(e);for(var o in i)this.getElementById(o)&&(a=i[o],s=t.generateLabel(t.getLabelBaseName(o)),this.setElementId(a,s),r||(r=Object.create(null)),r[o]=s);return r}},replaceNode:{value:function(e,t,r){var i;return i=this._resolveElementIdCollisions(e,r),this.normalizeRelativeUrls(e,this.getBaseUrl()),t.parentNode.replaceChild(e,t),i}},insertNodeBefore:{value:function(e,t,r){var i;return i=this._resolveElementIdCollisions(e,r),this.normalizeRelativeUrls(e,this.getBaseUrl()),t.parentNode.insertBefore(e,t),i}},appendNode:{value:function(e,t,r){var i;return i=this._resolveElementIdCollisions(e,r),this.normalizeRelativeUrls(e,this.getBaseUrl()),t.appendChild(e),i}},getElementId:{value:function(e){return e.getAttribute?e.getAttribute(this._ELEMENT_ID_ATTRIBUTE):void 0}},setElementId:{value:function(e,t){e.setAttribute(this._ELEMENT_ID_ATTRIBUTE,t)}},getElementIds:{value:function(){return this._getElementIds(this.document.body)}},_getElements:{value:function(e){var t,r,i="*["+this._ELEMENT_ID_ATTRIBUTE+"]",n={};t=e.querySelectorAll(i);for(var a,s=0;a=t[s];s++)r=this.getElementId(a),n[r]=a;return r=this.getElementId(e),r&&(n[r]=e),n}},_getChildrenElementIds:{value:function(e){var t,r="*["+this._ELEMENT_ID_ATTRIBUTE+"]",i=[];t=e.querySelectorAll(r);for(var n,a=0;n=t[a];a++)i.push(this.getElementId(n));return i}},_getElementIds:{value:function(e){var t,r=this._getChildrenElementIds(e);return t=this.getElementId(e),t&&r.push(t),r}},getElementById:{value:function(e){var t="*["+this._ELEMENT_ID_ATTRIBUTE+"='"+e+"']";return this.document.querySelector(t)}},html:{get:function(){var e=this.document;return this._removeObjects(e),this._addObjects(e,this.objectsString),this._getDoctypeString(e.doctype)+"\n"+e.documentElement.outerHTML}},_getDoctypeString:{value:function(e){return"<!DOCTYPE "+e.name+(e.publicId?' PUBLIC "'+e.publicId+'"':"")+(!e.publicId&&e.systemId?" SYSTEM":"")+(e.systemId?' "'+e.systemId+'"':"")+">"}},normalizeRelativeUrls:{value:function(e,t){if("string"==typeof t&&""!==t&&"about:blank"!==t)for(var r="http://www.w3.org/1999/xlink",i=/^[\w\-]+:|^\//,n=-1!==d._NORMALIZED_TAG_NAMES.indexOf(e.tagName)?[e]:e.querySelectorAll(d._NORMALIZED_TAG_NAMES_SELECTOR),a=0,s=n.length;s>a;a++){var o,l=n[a];"image"===l.tagName?(o=l.getAttributeNS(r,"href"),i.test(o)||l.setAttributeNS(r,"href",f.resolve(t,o))):l.hasAttribute("src")?(o=l.getAttribute("src"),""===o||i.test(o)||l.setAttribute("src",f.resolve(t,o))):l.hasAttribute("href")&&(o=l.getAttribute("href"),""===o||i.test(o)||l.setAttribute("href",f.resolve(t,o)))}}},replaceContentsWithTemplate:{value:function(e){this._require=e._require,this._baseUrl=e._baseUrl,this._document=e._document,this.objectsString=e.objectsString,this._instances=e._instances,this._templateFromElementContentsCache=e._templateFromElementContentsCache,this._metadata=e._metadata}},refresh:{value:function(){this.isDirty&&(this.refresher&&"function"==typeof this.refresher.refreshTemplate?(this.refresher.refreshTemplate(this),this.isDirty=!1):console.warn("Not able to refresh without a refresher.refreshTemplate."))}}},{_templateCache:{value:{moduleId:Object.create(null)}},_getTemplateCacheKey:{value:function(e,t){return e=t.resolve(e),t.location+"#"+e}},getTemplateWithModuleId:{value:function(e,t){var r,i;return r=this._getTemplateCacheKey(e,t),i=this._templateCache.moduleId[r],i||(i=(new d).initWithModuleId(e,t),this._templateCache.moduleId[r]=i),i}},_NORMALIZED_TAG_NAMES:{value:["IMG","image","IFRAME","link"]},__NORMALIZED_TAG_NAMES_SELECTOR:{value:null},_NORMALIZED_TAG_NAMES_SELECTOR:{get:function(){return this.__NORMALIZED_TAG_NAMES_SELECTOR||(this.__NORMALIZED_TAG_NAMES_SELECTOR=this._NORMALIZED_TAG_NAMES.join(",")),this.__NORMALIZED_TAG_NAMES_SELECTOR}}}),h=n.specialize({_resources:{value:null},_resourcesLoaded:{value:!1},template:{value:null},rootUrl:{value:""},constructor:{value:function h(){this._resources=Object.create(null)}},initWithTemplate:{value:function(e){this.template=e}},hasResources:{value:function(){return this.getStyles().length>0||this.getScripts().length>0}},resourcesLoaded:{value:function(){return this._resourcesLoaded}},loadResources:{value:function(e){return this._resourcesLoaded=!0,c.all([this.loadScripts(e),this.loadStyles(e)])}},getScripts:{value:function(){var e,t,r,i=this._resources.scripts;if(!i){t=this.template,i=this._resources.scripts=[],r=t.document.querySelectorAll("script");for(var n=0,a=r.length;a>n;n++)e=r[n],e.type!==this.template._SERIALIZATON_SCRIPT_TYPE&&i.push(e)}return i}},loadScripts:{value:function(e){var t,r=[];t=this.getScripts();for(var i=0,n=t.length;n>i;i++)r.push(this.loadScript(t[i],e));return c.all(r)}},loadScript:{value:function(e,t){var r,i;return r=o.getInstanceForDocument(t),i=this._cloneScriptElement(e,t),r.addScript(i)}},_cloneScriptElement:{value:function(e,t){for(var r,i=t.createElement("script"),n=e.attributes,a=0,s=n.length;s>a;a++)r=n[a],i.setAttribute(r.name,r.value);return i}},getStyles:{value:function(){var e,t,r,i=this._resources.styles;return i||(r='link[rel="stylesheet"], style',e=this.template,t=e.document.querySelectorAll(r),i=Array.prototype.slice.call(t,0),this._resources.styles=i),i}},loadStyles:{value:function(e){var t,r=[];t=this.getStyles();for(var i=0,n=t.length;n>i;i++)r.push(this.loadStyle(t[i],e));return c.all(r)}},loadStyle:{value:function(e,t){var r,i;return r=e.getAttribute("href"),r?(i=o.getInstanceForDocument(t),i.preloadResource(r)):c.resolve()}},createStylesForDocument:{value:function(e){for(var t,r,i=this.getStyles(),n=[],a=0;r=i[a];a++)t=e.importNode(r,!0),n.push(t);return n}}}),p=n.specialize({getTemplateArgumentElement:{value:function(){}},getTemplateArgumentSerialization:{value:function(){}},resolveTemplateArgumentTemplateProperty:{value:function(){}}});t.Template=d,t.TemplateArgumentProvider=p,t.TemplateResources=h,t.instantiateDocument=r}});