var Montage=require("../../core").Montage,Interpreter=require("mousse/deserialization/interpreter").Interpreter,Deserializer=require("mousse/deserialization/deserializer").Deserializer,MontageInterpreter=require("./montage-interpreter").MontageInterpreter,MontageReviver=require("./montage-reviver").MontageReviver,Promise=require("../../promise").Promise,JSHINT=require("../../jshint").JSHINT,logger=require("../../logger").logger("montage-deserializer"),MontageDeserializer=Montage.specialize.call(Deserializer,{_interpreter:{value:null},_serializationString:{value:null},_serialization:{value:null},init:{value:function(e,t,r){if(!this.isSerializationStringValid(e))throw Error(this._formatSerializationSyntaxError(e));return Deserializer.call(this,e),this._origin,this._serialization=null,this._interpreter=(new MontageInterpreter).init(t,r),this}},serialization:{get:function(){var e=this._serialization;return e||(e=JSON.parse(this._serializationString),this._serialization=e),e}},deserialize:{value:function(e,t){var r;try{r=JSON.parse(this._serializationString)}catch(n){return Promise.reject(n)}return this._interpreter.instantiate(r,e,t)}},preloadModules:{value:function(){var e=JSON.parse(this._serializationString);return this._interpreter.preloadModules(e)}},getExternalObjectLabels:{value:function(){var e=this.serialization,t=[];for(var r in e)0===Object.keys(e[r]).length&&t.push(r);return t}},isSerializationStringValid:{value:function(e){try{return JSON.parse(e),!0}catch(t){return!1}}},_formatSerializationSyntaxError:{value:function(e){var t,r,n,i,a,s="   ",o=this._origin;if(JSHINT(e))t="Syntax error in the serialization but not able to find it!\n"+e;else{r=JSHINT.errors[0],n=e.split("\n"),i=(s+n.length).length,a=r.line-1;for(var u=0,l=n.length;l>u;u++)n[u]=Array(i-(u+1+"").length+1).join(u===a?">":" ")+(u+1)+" "+n[u];t="Syntax error at line "+r.line+(o?" from "+o:"")+":\n"+r.evidence+"\n"+r.reason+"\n"+n.join("\n")}return t}}},{defineDeserializationUnit:{value:function(e,t){MontageReviver.defineUnitReviver(e,t)}}});exports.MontageDeserializer=MontageDeserializer,exports.deserialize=function(e,t){return(new MontageDeserializer).init(e,t).deserializeObject()};