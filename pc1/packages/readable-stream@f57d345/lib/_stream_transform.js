function TransformState(e,i){this.afterTransform=function(e,t){return afterTransform(i,e,t)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null}function afterTransform(e,i,t){var s=e._transformState;s.transforming=!1;var a=s.writecb;if(!a)return e.emit("error",Error("no writecb in Transform class"));s.writechunk=null,s.writecb=null,null!==t&&void 0!==t&&e.push(t),a&&a(i);var u=e._readableState;u.reading=!1,(u.needReadable||u.length<u.highWaterMark)&&e._read(u.highWaterMark)}function Transform(e){if(!(this instanceof Transform))return new Transform(e);Duplex.call(this,e),this._transformState=new TransformState(e,this);var i=this;this._readableState.needReadable=!0,this._readableState.sync=!1,this.once("finish",function(){"function"==typeof this._flush?this._flush(function(e){done(i,e)}):done(i)})}function done(e,i){if(i)return e.emit("error",i);var t=e._writableState;e._readableState;var s=e._transformState;if(t.length)throw Error("calling transform done when ws.length != 0");if(s.transforming)throw Error("calling transform done when still transforming");return e.push(null)}module.exports=Transform;var Duplex=require("./_stream_duplex"),util=require("core-util-is");util.inherits=require("inherits"),util.inherits(Transform,Duplex),Transform.prototype.push=function(e,i){return this._transformState.needTransform=!1,Duplex.prototype.push.call(this,e,i)},Transform.prototype._transform=function(){throw Error("not implemented")},Transform.prototype._write=function(e,i,t){var s=this._transformState;if(s.writecb=t,s.writechunk=e,s.writeencoding=i,!s.transforming){var a=this._readableState;(s.needTransform||a.needReadable||a.length<a.highWaterMark)&&this._read(a.highWaterMark)}},Transform.prototype._read=function(){var e=this._transformState;null!==e.writechunk&&e.writecb&&!e.transforming?(e.transforming=!0,this._transform(e.writechunk,e.writeencoding,e.afterTransform)):e.needTransform=!0};