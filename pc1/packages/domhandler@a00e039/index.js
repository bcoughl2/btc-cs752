function DomHandler(e,i,t){"object"==typeof e?(t=i,i=e,e=null):"function"==typeof i&&(t=i,i=defaultOpts),this._callback=e,this._options=i||defaultOpts,this._elementCB=t,this.dom=[],this._done=!1,this._tagStack=[]}var ElementType=require("domelementtype"),defaultOpts={ignoreWhitespace:!1};DomHandler.prototype.onreset=function(){DomHandler.call(this,this._callback,this._options,this._elementCB)},DomHandler.prototype.onend=function(){this._done||(this._done=!0,this._handleCallback(null))},DomHandler.prototype._handleCallback=DomHandler.prototype.onerror=function(e){if("function"==typeof this._callback)this._callback(e,this.dom);else if(e)throw e},DomHandler.prototype.onclosetag=function(){var e=this._tagStack.pop();this._elementCB&&this._elementCB(e)},DomHandler.prototype._addDomElement=function(e){var i=this._tagStack[this._tagStack.length-1];i?i.children.push(e):this.dom.push(e)},DomHandler.prototype.onopentag=function(e,i){var t=this._tagStack[this._tagStack.length-1],s={type:"script"===e?ElementType.Script:"style"===e?ElementType.Style:ElementType.Tag,name:e,attribs:i,children:[],prev:null,next:null,parent:t||null};if(t){for(var a=t.children.length;a>0;)if(ElementType.isTag(t.children[--a])){s.prev=t.children[a],t.children[a].next=s;break}t.children.push(s)}else this.dom.push(s);this._tagStack.push(s)},DomHandler.prototype.ontext=function(e){if(!this._options.ignoreWhitespace||""!==e.trim()){if(this._tagStack.length){var i;if((i=this._tagStack[this._tagStack.length-1])&&(i=i.children[i.children.length-1])&&i.type===ElementType.Text)return i.data+=e,void 0}else if(this.dom.length&&this.dom[this.dom.length-1].type===ElementType.Text)return this.dom[this.dom.length-1].data+=e,void 0;this._addDomElement({data:e,type:ElementType.Text})}},DomHandler.prototype.oncomment=function(e){var i=this._tagStack[this._tagStack.length-1];if(i&&i.type===ElementType.Comment)return i.data+=e,void 0;var t={data:e,type:ElementType.Comment};this._addDomElement(t),this._tagStack.push(t)},DomHandler.prototype.oncdatastart=function(){var e={children:[{data:"",type:ElementType.Text}],type:ElementType.CDATA};this._addDomElement(e),this._tagStack.push(e)},DomHandler.prototype.oncommentend=DomHandler.prototype.oncdataend=function(){this._tagStack.pop()},DomHandler.prototype.onprocessinginstruction=function(e,i){this._addDomElement({name:e,data:i,type:ElementType.Directive})},module.exports=DomHandler;