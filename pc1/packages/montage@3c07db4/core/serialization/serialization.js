var Montage=require("../core").Montage,MontageLabeler=require("./serializer/montage-labeler").MontageLabeler,MontageReviver=require("./deserializer/montage-reviver").MontageReviver,parse=require("frb/parse"),stringify=require("frb/stringify"),Serialization=Montage.specialize({_serializationString:{value:null},_serializationObject:{value:null},_serializationLabels:{value:null},initWithString:{value:function(e){return this._serializationString=e,this._serializationObject=null,this._serializationLabels=null,this}},initWithObject:{value:function(e){return this._serializationString=null,this._serializationObject=e,this._serializationLabels=null,this}},clone:{value:function(){var e=new Serialization;return e.initWithString(this.getSerializationString()),e}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var e;return this._serializationLabels||(e=this.getSerializationObject())&&(this._serializationLabels=Object.keys(e)),this._serializationLabels}},getExternalObjectLabels:{value:function(){var e=this.getSerializationObject(),t=[];for(var r in e)0===Object.keys(e[r]).length&&t.push(r);return t}},hasSerializationLabel:{value:function(e){return e in this.getSerializationObject()}},isExternalObject:{value:function(e){var t=this.getSerializationObject();return t&&e in t?0===Object.keys(t[e]).length:!1}},isAlias:{value:function(e){var t=this.getSerializationObject();return t&&e in t?"alias"in t[e]:!1}},getElementId:{value:function(e){var t=this.getSerializationObject(),r=Montage.getPath.call(t,e+".properties.element");return r?r["#"]:void 0}},getSerializationLabelsWithElements:{value:function(e){var t=new SerializationInspector,r=[];return t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&e.indexOf(t.data)>=0&&(t=t.parent,t&&"properties"===t.name&&(t=t.parent,t&&"montageObject"===t.type&&r.push(t.label)))}),r}},renameElementReferences:{value:function(e){var t=new SerializationInspector;t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&t.data in e&&(t.data=e[t.data])})}},renameSerializationLabels:{value:function(e){var t=new SerializationInspector;t.initWithSerialization(this),t.visitSerialization(function(t){if(t.label){var r=t.label;r in e&&(t.label=e[r])}if("reference"===t.type){var n=t.data;n in e&&(t.data=e[n])}})}},mergeSerialization:{value:function(e,t){return SerializationMerger.mergeSerializations(this,e,t)}},extractSerialization:{value:function(e,t){var r=new SerializationExtractor;return r.initWithSerialization(this),r.extractSerialization(e,t)}}}),SerializationMerger=Montage.specialize(null,{mergeSerializations:{value:function(e,t,r){var n,i,a,s,o,u,l={};a=e.getSerializationLabels(),s=t.getSerializationLabels(),o=this._createCollisionTable(a,s,l,r&&r.labeler),r&&r.willMergeObjectWithLabel&&(u=this._willMergeObjectWithLabel(r,e,t,l),o=o||u),o&&(t=t.clone(),t.renameSerializationLabels(l),s=t.getSerializationLabels()),n=e.getSerializationObject(),i=t.getSerializationObject();for(var c,f=0;c=s[f];f++)-1===a.indexOf(c)&&(n[c]=i[c]);return e.initWithObject(n),l}},_willMergeObjectWithLabel:{value:function(e,t,r,n){var i,a,s,o,u,l=!1,c=r.getSerializationLabels();n&&(s=[],Object.keys(n).forEach(function(e){s.push(n[e])}));for(var f,d=0;f=c[d];d++)if(a=n&&n[f],i=e.willMergeObjectWithLabel(f,a),"string"==typeof i){if(o=this._isLabelValidInSerialization(i,t),o||(u=!this._isLabelValidInSerialization(i,r)&&-1===s.indexOf(i)),!o&&!u)throw Error("willMergeObjectWithLabel either needs to return a label that exists in the destination serialization to indicate it's the same object or return a completely new label to rename the object being merged. \""+i+'"  destination: '+t.getSerializationString()+"\n source: "+r.getSerializationString()+"\n collision table: "+JSON.stringify(n,null,4));l=!0,n[f]=i}return l}},_isLabelValidInSerialization:{value:function(e,t){var r,n;return t.hasSerializationLabel(e)?!0:(n=e.indexOf(":"),n>0&&(r=e.slice(0,n),t.hasSerializationLabel(r))?!0:!1)}},_createCollisionTable:{value:function(e,t,r,n){for(var i,a,s,o,n=n||new MontageLabeler,u=!1,l=Object.create(null),c=0;e.length>c;c++)s=e[c],o=s.indexOf(":"),o>0&&(i=s.slice(0,o),n.addLabel(i),l[i]=1),n.addLabel(s),l[s]=1;for(var c=0;s=t[c];c++)o=s.indexOf(":"),o>0?(i=s.slice(0,o),a=r[i],a?(r[s]=a+":"+s.slice(o+1),u=!0):i in l?(a=n.generateLabel(n.getLabelBaseName(i)),t.indexOf(i)>=0&&(r[i]=a),r[s]=a+s.slice(o),u=!0):n.addLabel(i)):s in l&&!(s in r)?(r[s]=n.generateLabel(n.getLabelBaseName(s)),u=!0):n.addLabel(s);return u}}}),SerializationInspector=Montage.specialize({initWithSerialization:{value:function(e){this._serialization=e}},visitSerialization:{value:function(e){var t=this._serialization.getSerializationObject();this._walkRootObjects(e,t),this._serialization.initWithObject(t)}},visitSerializationObject:{value:function(e,t){var r=this._serialization.getSerializationObject();if(!(e in r))throw Error('Object "'+e+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(t,r,e),this._serialization.initWithObject(r)}},changeLabel:{value:function(e,t){var r,n=this._serialization.getSerializationObject();r=n[e],delete n[e],n[t]=r}},_walkRootObjects:{value:function(e,t){for(var r in t)this._walkRootObject(e,t,r)}},_walkRootObject:{value:function(e,t,r){var n=t[r];"value"in n?this._walkObject(e,n,"value",r):this._walkCustomObject(e,t,r)}},_walkObject:{value:function(e,t,r,n,i){var a,s=t[r],o=MontageReviver.getTypeOf(s);if(a={type:o},n?a.label=n:a.name=r,i&&(a.parent=i),"number"===o||"string"===o||"null"===o)a.data=s,e(a),t[r]=a.data;else if("regexp"===o)a.data=s["/"],e(a),s["/"]=a.data;else if("reference"===o)a.data=s["@"],e(a),s["@"]=a.data;else if("Element"===o)a.data=s["#"],e(a),s["#"]=a.data;else if("array"===o){a.data=s,e(a),t[r]=s=a.data;for(var u=0,l=s.length;l>u;u++)this._walkObject(e,s,""+u,null,a)}else if("object"===o){a.data=s,e(a),t[r]=s=a.data;for(var r in s)this._walkObject(e,s,r,null,a)}a.label!=n&&this.changeLabel(n,a.label)}},_walkCustomObject:{value:function(e,t,r){var n,i=t[r];n={type:"montageObject",label:r,data:i},e(n),t[r]=i=n.data,n.label!=r&&this.changeLabel(r,n.label),i.properties&&this._walkObject(e,i,"properties",null,n),i.listeners&&this._walkObject(e,i,"listeners",null,n),i.bindings&&this._walkBindings(e,i,null,n),i.localizations&&this._walkLocalizations(e,i,null,n)}},_walkBindings:{value:function(e,t,r){var n,i=t.bindings;n={type:"bindings",data:i,parent:r},e(n),t.bindings=i=n.data;for(var a in i)this._walkBinding(e,i,a,n)}},_walkBinding:{value:function(e,t,r,n){var i,a=t[r];i={type:"binding",name:r,data:a,parent:n},e(i),t[r]=a=i.data,this._walkBindingData(e,a,i)}},_walkBindingData:{value:function(e,t,r){var n,i,a=!1;n=t["<-"]||t["<->"],i=parse(n),this._walksBindingReferences(i,function(t){var r={type:"reference",data:t.label};e(r),t.label!==r.data&&(t.label=r.data,a=!0)}),a&&("<-"in t?t["<-"]=stringify(i):t["<->"]=stringify(i)),t.converter&&this._walkObject(e,t,"converter",null,r)}},_walkLocalizations:{value:function(e,t,r){var n,i=t.localizations;n={type:"localizations",data:i,parent:r},e(n),t.localizations=i=n.data;for(var a in i)this._walkLocalization(e,i,a,n)}},_walkLocalization:{value:function(e,t,r,n){var i,a,s=t[r];if(i={type:"localization",name:r,data:s,parent:n},e(i),t[r]=s=i.data,"object"==typeof s.key&&this._walkBindingData(e,s.key,i),"object"==typeof s.default&&this._walkBindingData(e,s.default,i),"object"==typeof s.data){a=s.data;for(var r in a)this._walkBindingData(e,a[r],i)}}},_walksBindingReferences:{value:function(e,t){var r=e.args;if("component"===e.type&&t(e),r)for(var n=0,i=r.length;i>n;n++)this._walksBindingReferences(r[n],t)}}}),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(e){this._serialization=e}},extractSerialization:{value:function(e,t){var r,n=new SerializationInspector,i={},a=[];r=this._serialization.getSerializationObject(),n.initWithSerialization(this._serialization);for(var s,o=0;s=e[o];o++)i[s]=r[s],n.visitSerializationObject(s,function(t){var r;"reference"===t.type&&(r=t.data,-1===a.indexOf(r)&&-1===e.indexOf(r)&&a.push(r))});if(t)for(var s,o=0;s=t[o];o++)s in r&&!(s in i)&&(i[s]={});for(var s,o=0;s=a[o];o++)i[s]={};return(new Serialization).initWithObject(i)}}});exports.Serialization=Serialization,exports.SerializationMerger=SerializationMerger,exports.SerializationInspector=SerializationInspector,exports.SerializationExtractor=SerializationExtractor;