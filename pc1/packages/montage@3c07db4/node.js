function parseHtml(e){var t,r,n=new htmlparser.DomHandler(function(e,n){r=e,t=n}),i=new htmlparser.Parser(n);if(i.write(e),i.done(),r)throw r;if(!t)throw Error("HTML parsing did not complete");return{type:"document",children:t}}function visit(e,t){var r,n=function(){r=!0};if(t(e,n),!r)for(var i=e.children,a=i?i.length:0,o=0;a>o;o++)visit(i[o],t)}function getAttribute(e,t){return e.attribs?e.attribs[t]:null}function getText(e){return DomUtils.getText(e)}function parsePrototypeForModule(e){return e.replace(/\[[^\]]+\]$/,"")}var FS=require("q-io/fs"),MontageBoot=require("./montage"),Require=require("mr/require");require("mr/node");var Promise=require("q"),URL=require("url"),htmlparser=require("htmlparser2"),DomUtils=htmlparser.DomUtils;Require.overlays=["node","server","montage"],exports.bootstrap=function(){var e=process.argv.slice(0,3),t=process.argv.slice(2),r=t.shift();return FS.canonical(r).then(function(r){return findPackage(r).fail(function(n){if("Can't find package"!==n.message)throw Error(n);loadFreeModule(r,e,t)}).then(function(n){return loadPackagedModule(n,r,e,t)})})};var findPackage=function(e){var t=FS.directory(e);if(t===e)throw Error("Can't find package");return FS.join(t,"package.json"),FS.stat(e).then(function(e){return e.isFile()?t:findPackage(t)})},loadFreeModule=function(){throw Error("Can't load module that is not in a package")},loadPackagedModule=function(e,t){return MontageBoot.loadPackage(e).then(function(r){var n=t.slice(e.length+1);return r.async(n)}).done()};MontageBoot.loadPackage=function(e,t){return"/"!==e.slice(e.length-1,e.length)&&(e+="/"),t=t||{},t.location=URL.resolve(Require.getLocation(),e),t.moduleTypes=["html","meta"],t.makeLoader=function(e){return MontageBoot.ReelLoader(e,Require.makeLoader(e))},t.makeCompiler=function(e){return MontageBoot.TemplateCompiler(e,MontageBoot.SerializationCompiler(e,Require.makeCompiler(e)))},Require.loadPackage(t.location,t)},MontageBoot.TemplateLoader=function(e,t){return function(e,r){var n=e.match(/(.*\/)?(?=[^\/]+\.html$)/),i=e.match(/(?=[^\/]+\.json$)/),a=e.match(/(.*\/)?([^\/]+)\.reel\/\2$/);return n?t(e,r).then(function(){return r.dependencies=parseHtmlDependencies(r.text,r.location),r}):i?t(e,r).then(function(){return r.dependencies=collectSerializationDependencies(r.text,[]),r}):a?t(e,r).then(function(){var t=URL.resolve(r.location,a[2]+".html");return FS.stat(URL.parse(t).pathname).then(function(t){t.isFile()&&(r.extraDependencies=[e+".html"])},function(){})}):t(e,r)}},Require.makeLoader=function(e){return function(t){return MontageBoot.TemplateLoader(t,e(t))}}(Require.makeLoader);var parseHtmlDependencies=function(e){var t=[],r=parseHtml(e);return collectHtmlDependencies(r,t),t},collectHtmlDependencies=function(e,t){visit(e,function(e){DomUtils.isTag(e)&&("script"===e.name?"text/montage-serialization"===getAttribute(e,"type")&&collectSerializationDependencies(getText(e),t):"link"===e.name&&"text/montage-serialization"===getAttribute(e,"type")&&t.push(getAttribute(e,"href")))})},collectSerializationDependencies=function(e,t){var r=JSON.parse(e);return Object.keys(r).forEach(function(e){var n=r[e];n.lazy||("string"==typeof n.prototype&&t.push(parsePrototypeForModule(n.prototype)),"string"==typeof n.object&&t.push(parsePrototypeForModule(n.object)))}),t};