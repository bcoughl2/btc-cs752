require("runtime/dependencies/gl-matrix");var GLSLProgram=require("runtime/glsl-program").GLSLProgram,WebGLTFResourceManager=require("runtime/helpers/resource-manager").WebGLTFResourceManager;exports.WebGLRenderer=Object.create(Object.prototype,{MODEL:{value:"MODEL",writable:!1},VIEW:{value:"VIEW",writable:!1},PROJECTION:{value:"PROJECTION",writable:!1},MODELVIEW:{value:"MODELVIEW",writable:!1},VIEWPROJECTION:{value:"VIEWPROJECTION",writable:!1},MODELVIEWPROJECTION:{value:"MODELVIEWPROJECTION",writable:!1},MODELINVERSE:{value:"MODELINVERSE",writable:!1},VIEWINVERSE:{value:"VIEWINVERSE",writable:!1},PROJECTIONINVERSE:{value:"PROJECTIONINVERSE",writable:!1},MODELVIEWINVERSE:{value:"MODELVIEWINVERSE",writable:!1},VIEWPROJECTIONINVERSE:{value:"VIEWPROJECTIONINVERSE",writable:!1},MODELVIEWPROJECTIONINVERSE:{value:"MODELVIEWPROJECTIONINVERSE",writable:!1},MODELTRANSPOSE:{value:"MODELTRANSPOSE",writable:!1},VIEWTRANSPOSE:{value:"VIEWTRANSPOSE",writable:!1},PROJECTIONTRANSPOSE:{value:"PROJECTIONTRANSPOSE",writable:!1},MODELVIEWTRANSPOSE:{value:"MODELVIEWTRANSPOSE",writable:!1},VIEWPROJECTIONTRANSPOSE:{value:"VIEWPROJECTIONTRANSPOSE",writable:!1},MODELVIEWPROJECTIONTRANSPOSE:{value:"MODELVIEWPROJECTIONTRANSPOSE",writable:!1},MODELINVERSETRANSPOSE:{value:"MODELINVERSETRANSPOSE",writable:!1},VIEWINVERSETRANSPOSE:{value:"VIEWINVERSETRANSPOSE",writable:!1},PROJECTIONINVERSETRANSPOSE:{value:"PROJECTIONINVERSETRANSPOSE",writable:!1},MODELVIEWINVERSETRANSPOSE:{value:"MODELVIEWINVERSETRANSPOSE",writable:!1},VIEWPROJECTIONINVERSETRANSPOSE:{value:"VIEWPROJECTIONINVERSETRANSPOSE",writable:!1},MODELVIEWPROJECTIONINVERSETRANSPOSE:{value:"MODELVIEWPROJECTIONINVERSETRANSPOSE",writable:!1},_bindedProgram:{value:null,writable:!0},_debugProgram:{value:null,writable:!0},_resourceManager:{value:null,writable:!0},_webGLContext:{value:null,writable:!0},_projectionMatrix:{value:null,writable:!0},shininess:{value:200,writable:!0},light:{value:[0,0,-1],writable:!0},specularColor:{value:[1,1,1],writable:!0},GLContextDidChange:{value:function(){}},initWithWebGLContext:{value:function(e){return this.webGLContext=e,this._states={},this}},bindedProgram:{get:function(){return this._bindedProgram},set:function(e){this._bindedProgram!==e&&this._webGLContext&&(this._bindedProgram=e,this._bindedProgram&&this._bindedProgram.use(this._webGLContext,!1))}},projectionMatrix:{get:function(){return this._projectionMatrix},set:function(e){this._projectionMatrix=e}},debugProgram:{get:function(){if(!this._debugProgram){this._debugProgram=Object.create(GLSLProgram);var e="precision highp float;attribute vec3 vert;uniform mat4 u_mvMatrix; uniform mat4 u_projMatrix; void main(void) { gl_Position = u_projMatrix * u_mvMatrix * vec4(vert,1.0); }",t="precision highp float;void main(void) { gl_FragColor = vec4(1.,0.,0.,1.); }";this._debugProgram.initWithShaders({"x-shader/x-vertex":e,"x-shader/x-fragment":t}),this._debugProgram.build(this.webGLContext)||console.log(this._debugProgram.errorLogs)}return this._debugProgram}},webGLContext:{get:function(){return this._webGLContext},set:function(e){this._webGLContext=e,this.GLContextDidChange()}},resourceManager:{get:function(){return this._resourceManager||(this._resourceManager=Object.create(WebGLTFResourceManager),this._resourceManager.init()),this._resourceManager}},indicesDelegate:{value:{webGLContext:{value:null,writable:!0},handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t,i){var n=i,r=n.getParameter(n.ELEMENT_ARRAY_BUFFER_BINDING),a=n.createBuffer();return n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,a),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,r),a},resourceAvailable:function(){}}},setupCompressedMesh:{value:function(e,t,i){var n=e.primitives[0],r=this.webGLContext,a=r.getParameter(r.ELEMENT_ARRAY_BUFFER_BINDING),s=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.bufferData(r.ELEMENT_ARRAY_BUFFER,i,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a),s.count=i.length,this.resourceManager.setResource(n.indices.id,s),n.indices={id:n.indices.id,count:s.count};var o,l=t.length/8,u=new Float32Array(3*l),c=new Float32Array(3*l),h=new Float32Array(2*l);for(o=0;l>o;o++){var d=8*o;u[3*o+0]=t[d+0],u[3*o+1]=t[d+1],u[3*o+2]=t[d+2],c[3*o+0]=t[d+5],c[3*o+1]=t[d+6],c[3*o+2]=t[d+7],h[2*o+0]=t[d+3],h[2*o+1]=t[d+4]}a=r.getParameter(r.ARRAY_BUFFER_BINDING),s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,u,r.STATIC_DRAW),s.componentType=r.FLOAT,s.componentsPerAttribute=3,this.resourceManager.setResource(n.semantics.POSITION.id,s),n.semantics.POSITION={id:n.semantics.POSITION.id,count:l,byteStride:12},s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,c,r.STATIC_DRAW),s.componentType=r.FLOAT,s.componentsPerAttribute=3,this.resourceManager.setResource(n.semantics.NORMAL.id,s),n.semantics.NORMAL={id:n.semantics.NORMAL.id,count:l,byteStride:12},h.length>0&&(s=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,h,r.STATIC_DRAW),s.componentType=r.FLOAT,s.componentsPerAttribute=2,this.resourceManager.setResource(n.semantics.TEXCOORD_0.id,s),n.semantics.TEXCOORD_0={id:n.semantics.TEXCOORD_0.id,count:l,byteStride:8}),r.bindBuffer(r.ARRAY_BUFFER,a)}},setupCompressedMesh2:{value:function(e,t,i,n,r,a,s){for(var o=this.webGLContext,l=0,u=0,c=e.primitives,h=0;c.length>h;h++){var d=e.primitives[h],m=d.indices.id;l=d.indices.count;var f=new Int16Array(s.subarray(u,u+l)),p=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,p),o.bufferData(o.ELEMENT_ARRAY_BUFFER,f,o.STATIC_DRAW),this.resourceManager.setResource(m,p),p.count=l,d.indices={id:m,count:p.count},u+=l}for(var _,v={},h=0;c.length>h;h++){var d=e.primitives[h];for(_ in d.semantics){var g=d.semantics[_];v[g.baseId]=_}}for(var b in v){var y=a[b];if(null!=y){var w=r.GetFloatAttribute(y),_=v[b];if("JOINT"===_)for(var T=0;w.length>T;T++)w[T]=Math.floor(w[T]+.5);var S=r.GetFloatAttributeDim(y);p=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,p),o.bufferData(o.ARRAY_BUFFER,w,o.STATIC_DRAW),p.componentType=o.FLOAT,p.componentsPerAttribute=S,this.resourceManager.setResource(d.semantics[_].id,p),d.semantics[_]={id:d.semantics[_].id,count:l,byteStride:4*S}}}l=t,previousBuffer=o.getParameter(o.ARRAY_BUFFER_BINDING),p=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,p),o.bufferData(o.ARRAY_BUFFER,i,o.STATIC_DRAW),p.componentType=o.FLOAT,p.componentsPerAttribute=3,this.resourceManager.setResource(d.semantics.POSITION.id,p),d.semantics.POSITION={id:d.semantics.POSITION.id,count:l,byteStride:12},null!=n&&(p=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,p),o.bufferData(o.ARRAY_BUFFER,n,o.STATIC_DRAW),p.componentType=o.FLOAT,p.componentsPerAttribute=3,this.resourceManager.setResource(d.semantics.NORMAL.id,p),d.semantics.NORMAL={id:d.semantics.NORMAL.id,count:l,byteStride:12}),o.bindBuffer(o.ARRAY_BUFFER,previousBuffer)}},vertexAttributeBufferDelegate:{value:{_componentTypeForGLType:function(e,t){switch(t){case e.FLOAT:case e.FLOAT_VEC2:case e.FLOAT_VEC3:case e.FLOAT_VEC4:return e.FLOAT;case e.UNSIGNED_BYTE:return e.UNSIGNED_BYTE;case e.UNSIGNED_SHORT:return e.UNSIGNED_SHORT;default:return null}},_componentsPerElementForGLType:function(e,t){switch(t){case e.FLOAT:case e.UNSIGNED_BYTE:case e.UNSIGNED_SHORT:return 1;case e.FLOAT_VEC2:return 2;case e.FLOAT_VEC3:return 3;case e.FLOAT_VEC4:return 4;default:return null}},webGLContext:{value:null,writable:!0},handleError:function(e,t){console.log("ERROR:vertexAttributeBufferDelegate:"+e+" :"+t)},convert:function(e,t,i){var n=e,r=i,a=r.getParameter(r.ARRAY_BUFFER_BINDING),s=r.createBuffer();return r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW),s.componentType=this._componentTypeForGLType(r,n.type),s.componentsPerAttribute=this._componentsPerElementForGLType(r,n.type),r.bindBuffer(r.ARRAY_BUFFER,a),s},resourceAvailable:function(){}}},textureDelegate:{value:{getGLFilter:function(e){return null==e?WebGLRenderingContext.LINEAR:e},getGLWrapMode:function(e){return null==e?WebGLRenderingContext.REPEAT:e},handleError:function(e,t){console.log("ERROR:textureDelegate:"+e+" :"+t)},nextHighestPowerOfTwo:function(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1},isPowerOfTwo:function(e){return 0==(e&e-1)},installCubemapSide:function(e,t,i,n){e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texImage2D(t,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_CUBE_MAP,null)},createTextureFromImageAndSampler:function(e,t,i){var n=i.getParameter(i.ACTIVE_TEXTURE),r=i.getParameter(i.TEXTURE_BINDING_2D);i.activeTexture(i.TEXTURE0);var a=null,s=this.getGLFilter(t.minFilter),o=this.getGLFilter(t.magFilter),l=this.getGLWrapMode(t.wrapS),u=this.getGLWrapMode(t.wrapT),c=!1,h=s===i.NEAREST_MIPMAP_NEAREST||s===i.LINEAR_MIPMAP_NEAREST||s===i.NEAREST_MIPMAP_LINEAR||s===i.LINEAR_MIPMAP_LINEAR;if(h||l===i.REPEAT||u===i.REPEAT){var d=parseInt(e.width),m=parseInt(e.height);if(this.isPowerOfTwo(d)||(d=this.nextHighestPowerOfTwo(d),c=!0),this.isPowerOfTwo(m)||(m=this.nextHighestPowerOfTwo(m),c=!0),c){a=document.createElement("canvas"),a.width=d,a.height=m;var f=a.getContext("2d");f.drawImage(e,0,0,parseInt(a.width),parseInt(a.height)),a.id=e.id,e=a}}var p=i.createTexture();return p.contextID=i.contextID,i.bindTexture(i.TEXTURE_2D,p),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,l),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,u),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,o),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),h&&i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,r),i.activeTexture(n),p},convert:function(e,t,i){var n=i;if(e){if(6===e.length){var r=n.createTexture();return n.bindTexture(n.TEXTURE_CUBE_MAP,r),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.installCubemapSide(n,n.TEXTURE_CUBE_MAP_POSITIVE_X,r,e[0]),this.installCubemapSide(n,n.TEXTURE_CUBE_MAP_NEGATIVE_X,r,e[1]),this.installCubemapSide(n,n.TEXTURE_CUBE_MAP_POSITIVE_Y,r,e[2]),this.installCubemapSide(n,n.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,e[3]),this.installCubemapSide(n,n.TEXTURE_CUBE_MAP_POSITIVE_Z,r,e[4]),this.installCubemapSide(n,n.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,e[5]),r}}else if("video"==e.type){t.source.videoElement=e;var a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t.source.videoElement),n.bindTexture(n.TEXTURE_2D,null),a}return this.createTextureFromImageAndSampler(e,t.sampler,n)},resourceAvailable:function(){}}},_lastMaxEnabledArray:{value:0,writable:!0},_states:{value:null,writable:!0},setState:{value:function(e,t,i){var n=this.webGLContext;(null==this._states[e]||1==i||this._states[e]!==t)&&(this._states[e]=t,t?n.enable(e):n.disable(e))}},resetStates:{value:function(){var e=this.webGLContext;if(e&&-1!==this._lastMaxEnabledArray)for(var t=0;this._lastMaxEnabledArray>t;t++)e.disableVertexAttribArray(t);this._lastMaxEnabledArray=-1,this.bindedProgram=null,this.setState(e.BLEND,!1)}},renderPrimitive:{value:function(e,t,i,n){var r=!1,a=null,s=e.primitive;e.node&&e.node.instanceSkin&&e.node.instanceSkin.skin.process(e.node,this.resourceManager);var o,l=-1,u=this.webGLContext,c=this.bindedProgram,h=0;n||(n=s.material.parameters);var d=c.uniformSymbols;for(o=0;d.length>o;o++){var m=d[o],f=t.instanceProgram.uniforms[m];if(a=null,f=n[f],f&&null!=f.semantic){var p=e.nodeWrapper;f.source&&(p=e.nodeWrapper.scenePassRenderer._nodeWrappers[f.source.id]);var _=f.semantic;_===this.PROJECTION?a=this.projectionMatrix:_===this.MODELVIEW?a=p.worldViewMatrix:_===this.MODELVIEWINVERSETRANSPOSE?a=p.worldViewInverseTransposeMatrix:_===this.MODELVIEWINVERSE&&(a=p.worldViewInverseMatrix)}if(null==a&&null!=f)if(f.source&&null==_){var p=e.nodeWrapper.scenePassRenderer._nodeWrappers[f.source.id];a=p.worldViewMatrix}else a=f.value;var v=null;if(null!=a){var g=c.getTypeForSymbol(m),b=g===u.SAMPLER_CUBE,y=g===u.SAMPLER_2D;if(b){if(v=this.resourceManager.getResource(a,this.textureDelegate,this.webGLContext)){u.activeTexture(u.TEXTURE0+h),u.bindTexture(u.TEXTURE_CUBE_MAP,v);var w=c.getLocationForSymbol(m);w!==void 0&&(c.setValueForSymbol(m,h),h++)}}else if(y){if(v=this.resourceManager.getResource(a,this.textureDelegate,this.webGLContext),null!=v){u.activeTexture(u.TEXTURE0+h),u.bindTexture(u.TEXTURE_2D,v),f.value.source.videoElement&&f.value.source.timeStamp!=i&&(u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,f.value.source.videoElement),f.value.source.timeStamp=i);var w=c.getLocationForSymbol(m);w!==void 0&&(c.setValueForSymbol(m,h),h++)}}else c.setValueForSymbol(m,a)}}c.commit(u);var T=0,S=t.instanceProgram.attributes,C=c.attributeSymbols;for(o=0;C.length>o;o++){var m=C[o],f=S[m];f=n[f];var _=f.semantic,E=s.semantics[_],D=null;if(D=e.compressed?this.resourceManager._getResource(E.id):this.resourceManager.getResource(E,this.vertexAttributeBufferDelegate,this.webGLContext)){u.bindBuffer(u.ARRAY_BUFFER,D);var O=c.getLocationForSymbol(m);O!==void 0&&(O>l&&(l=O),u.enableVertexAttribArray(O),u.vertexAttribPointer(O,D.componentsPerAttribute,D.componentType,!1,E.byteStride,0),r&&"POSITION"==_&&u.drawArrays(u.POINTS,0,E.count)),T++}else this._lastMaxEnabledArray=-1}var I=T===C.length;if(!r){if(I)for(var o=l+1;this._lastMaxEnabledArray>o;o++)u.disableVertexAttribArray(o);var M=null;M=e.compressed?this.resourceManager._getResource(s.indices.id):this.resourceManager.getResource(s.indices,this.indicesDelegate,this.webGLContext),M&&I&&(u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,M),u.drawElements(u.TRIANGLES,s.indices.count,u.UNSIGNED_SHORT,0))}return this._lastMaxEnabledArray=l,I}},programDelegate:{value:{handleError:function(e,t){console.log("ERROR:programDelegate:"+e+" :"+t)},convert:function(e,t,i){var n=i,r=Object.create(GLSLProgram);return r.initWithShaders(t),r.build(n)||(console.log(t),console.log(r.errorLogs)),r},resourceAvailable:function(){}}},bindRenderTarget:{value:function(e){var t=this.webGLContext,i=e.FBO?!1:!0;e.previousFBO=t.getParameter(t.FRAMEBUFFER_BINDING),e.FBO||(e.FBO=t.createFramebuffer(),i=!0),t.bindFramebuffer(t.FRAMEBUFFER,e.FBO);var n=e.extras,r=t.drawingBufferWidth!=e.width||t.drawingBufferHeight!=e.height,a=t.drawingBufferWidth,s=t.drawingBufferHeight;(i||r)&&e.attachments.forEach(function(e){if("COLOR_ATTACHMENT0"==e.semantic&&n.picking){var o=t.getParameter(t.TEXTURE_BINDING_2D);i&&(n.pickingTexture=t.createTexture()),r&&(t.bindTexture(t.TEXTURE_2D,n.pickingTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,a,s,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)),i&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n.pickingTexture,0),t.bindTexture(t.TEXTURE_2D,o)}if("DEPTH_ATTACHMENT"==e.semantic&&n.picking){var l=t.getParameter(t.RENDERBUFFER_BINDING);i&&(n.pickingRenderBuffer=t.createRenderbuffer()),r&&(t.bindRenderbuffer(t.RENDERBUFFER,n.pickingRenderBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,a,s)),i&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,n.pickingRenderBuffer),t.bindRenderbuffer(t.RENDERBUFFER,l)}},this),t.clearColor(0,0,0,1),t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT)}},unbindRenderTarget:{value:function(e){var t=this.webGLContext;e.extras.picking&&(e.extras.pickedPixel||(e.extras.pickedPixel=new Uint8Array(4)),t.finish(),t.readPixels(e.extras.coords[0],e.extras.coords[1],1,1,t.RGBA,t.UNSIGNED_BYTE,e.extras.pickedPixel)),t.bindFramebuffer(t.FRAMEBUFFER,e.previousFBO);var i=!1;i&&e.attachments.forEach(function(t){"COLOR_ATTACHMENT0"===t.semantic&&e.extras.picking&&this.drawTexture(e.extras.pickingTexture)},this)}},renderPrimitivesWithPass:{value:function(e,t,i,n,r){var a=e.length,s=this.webGLContext;if(t.instanceProgram){var o=s,l=this.resourceManager.getResource(t.instanceProgram.program,this.programDelegate,o);if(l){var u=0,c=1,h=1,d=1,m=t.states,f=s.FUNC_ADD,p=s.SRC_ALPHA,_=s.ONE_MINUS_SRC_ALPHA,v="__PickingPass"===t.id;if(m&&(null!=m.blendEnable&&(u=m.blendEnable),null!=m.depthTestEnable&&(c=m.depthTestEnable),null!=m.depthMask&&(h=m.depthMask),null!=m.cullFaceEnable&&(d=m.cullFaceEnable),null!=m.blendEquation)){var g=m.blendFunc;null!=g&&(null!=g.sfactor&&(p=g.sfactor),null!=g.dfactor&&(_=g.dfactor))}if(this.setState(s.DEPTH_TEST,c),this.setState(s.CULL_FACE,d),s.enable(s.SAMPLE_ALPHA_TO_COVERAGE),s.depthMask(h),this.setState(s.BLEND,u),1===u&&(s.blendEquation(f),s.blendFunc(p,_)),this.bindedProgram=l,v)for(var b=0;a>b;b++){var y=e[b];if(!y.node.hidden){if(!y.pickingColor)if("node"===r){var w=y.node.baseId;if(w){var T=t.extras.nodeIDToColor[w];T||(T=vec4.createFrom(Math.random(),Math.random(),Math.random(),1),t.extras.nodeIDToColor[w]=T),y.pickingColor=T}}else if("material"===r){var S=y.primitive.material.baseId;if(S){var C=t.extras.materialIDToColor[S];C||(C=vec4.createFrom(Math.random(),Math.random(),Math.random(),1),t.extras.materialIDToColor[S]=C),y.pickingColor=C}}this.bindedProgram.setValueForSymbol("u_pickingColor",y.pickingColor),this.renderPrimitive(y,t,n,i)}}else for(var b=0;a>b;b++){var y=e[b];if(!y.node.hidden){var E=1;i=y.primitive.material.parameters;var D=i.transparency;D&&null!=D.value&&(E*=D.value);var O=i.filterColor;O&&null!=O.value&&(E*=O.value[3]),1e-5>E||(1>E&&!u?(this.setState(s.BLEND,!0),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),this.renderPrimitive(y,t,n),this.setState(s.BLEND,!1)):this.renderPrimitive(y,t,n))}}}}}},_BBOXProgram:{value:null,writable:!0},drawBBOX:{value:function(e,t,i,n){if(null!=e){var r=this.webGLContext;if(this.bindedProgram=null,this.setState(r.CULL_FACE,!1),!this._BBOXProgram){this._BBOXProgram=Object.create(GLSLProgram);var a="precision highp float;attribute vec3 vert;uniform mat4 u_projMatrix; uniform mat4 u_vMatrix; uniform mat4 u_mMatrix; void main(void) { gl_Position = u_projMatrix * u_vMatrix * u_mMatrix * vec4(vert,1.0); }",s="precision highp float;uniform float u_transparency;  void main(void) {  gl_FragColor = vec4(vec3(1.,1.,1.) , u_transparency);}";this._BBOXProgram.initWithShaders({"x-shader/x-vertex":a,"x-shader/x-fragment":s}),this._BBOXProgram.build(r)||console.log(this._BBOXProgram.errorLogs)}var o=[e[0][0],e[0][1],e[0][2]],l=[e[1][0],e[1][1],e[1][2]],u=0,c=1,h=2;if(!this._BBOXIndices){var d=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,3,7,2,6,0,4,1,5];this._BBOXIndices=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._BBOXIndices),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(d),r.STATIC_DRAW)}r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._BBOXIndices),this._BBOXVertexBuffer||(this._BBOXVertexBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this._BBOXVertexBuffer)),r.bindBuffer(r.ARRAY_BUFFER,this._BBOXVertexBuffer);var m=[l[u],o[c],o[h],l[u],l[c],o[h],o[u],l[c],o[h],o[u],o[c],o[h],l[u],o[c],l[h],l[u],l[c],l[h],o[u],l[c],l[h],o[u],o[c],l[h]];r.bufferData(r.ARRAY_BUFFER,new Float32Array(m),r.STATIC_DRAW);var f=this._BBOXProgram.getLocationForSymbol("vert");null!=f&&(r.enableVertexAttribArray(f),r.vertexAttribPointer(f,3,r.FLOAT,!1,12,0)),this.bindedProgram=this._BBOXProgram;var p=this._BBOXProgram.getLocationForSymbol("u_projMatrix");p&&this._BBOXProgram.setValueForSymbol("u_projMatrix",n);var _=this._BBOXProgram.getLocationForSymbol("u_mMatrix");_&&this._BBOXProgram.setValueForSymbol("u_mMatrix",i);var v=this._BBOXProgram.getLocationForSymbol("u_vMatrix");v&&this._BBOXProgram.setValueForSymbol("u_vMatrix",t);var g=this._BBOXProgram.getLocationForSymbol("u_transparency");g&&this._BBOXProgram.setValueForSymbol("u_transparency",1),this._BBOXProgram.commit(r),r.drawElements(r.LINES,24,r.UNSIGNED_SHORT,0),r.disableVertexAttribArray(f),this.setState(r.BLEND,!1),this.setState(r.CULL_FACE,!0)}}},drawTexture:{value:function(e){var t=this.webGLContext,i=t.isEnabled(t.DEPTH_TEST),n=t.isEnabled(t.CULL_FACE),r=t.isEnabled(t.BLEND);if(this.setState(t.DEPTH_TEST,0),this.setState(t.CULL_FACE,0),this.setState(t.BLEND,0),!this.displayTexture){this.displayTexture={},this.displayTexture.program=Object.create(GLSLProgram);var a="precision highp float;attribute vec3 vert;attribute vec2 uv;uniform mat4 u_projMatrix; varying vec2 v_uv;void main(void) { v_uv = uv;gl_Position = u_projMatrix * vec4(vert,1.0); }",s="precision highp float;uniform sampler2D u_texture;varying vec2 v_uv; void main(void) {  vec4 color = texture2D(u_texture, v_uv);  gl_FragColor = color; }";this.displayTexture.program.initWithShaders({"x-shader/x-vertex":a,"x-shader/x-fragment":s}),this.displayTexture.program.build(t)||console.log(this.displayTexture.program.errorLogs);var o=[-1,-1,0,0,0,1,-1,0,1,0,-1,1,0,0,1,-1,1,0,0,1,1,-1,0,1,0,1,1,0,1,1];this.displayTexture.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.displayTexture.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW)}var l=this.displayTexture.program,u=this.displayTexture.vertexBuffer;t.bindBuffer(t.ARRAY_BUFFER,u);var c=mat4.ortho(-1,1,-1,1,0,1e3),h=l.getLocationForSymbol("vert"),d=h!==void 0;d&&(t.enableVertexAttribArray(h),t.vertexAttribPointer(h,3,t.FLOAT,!1,20,0));var m=l.getLocationForSymbol("uv"),f=m!==void 0;f&&(t.enableVertexAttribArray(m),t.vertexAttribPointer(m,2,t.FLOAT,!1,20,12));var p=t.getParameter(t.TEXTURE_BINDING_2D);t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e),this.bindedProgram=l;var _=l.getLocationForSymbol("u_projMatrix");_&&l.setValueForSymbol("u_projMatrix",c);var v=l.getLocationForSymbol("u_texture");v&&l.setValueForSymbol("u_texture",0),l.commit(t),t.drawArrays(t.TRIANGLES,0,6),t.bindTexture(t.TEXTURE_2D,p),d&&t.disableVertexAttribArray(h),f&&t.disableVertexAttribArray(m),this.setState(t.DEPTH_TEST,i),this.setState(t.CULL_FACE,n),this.setState(t.BLEND,r)}}});