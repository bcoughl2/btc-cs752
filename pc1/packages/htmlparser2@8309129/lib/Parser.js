function Parser(e,t){t||(t=defaultOpts),e||(e=defaultCbs),this._options=t,this._cbs=e,this._tagname="",this._attribname="",this._attribs=null,this._stack=[],this._done=!1,this._tokenizer=new Tokenizer(t,this)}var Tokenizer=require("./Tokenizer.js"),defaultOpts={xmlMode:!1,lowerCaseAttributeNames:!1,lowerCaseTags:!1},defaultCbs={},formTags={input:!0,option:!0,optgroup:!0,select:!0,button:!0,datalist:!0,textarea:!0},openImpliesClose={tr:{tr:!0,th:!0,td:!0},th:{th:!0},td:{thead:!0,td:!0},body:{head:!0,link:!0,script:!0},li:{li:!0},p:{p:!0},select:formTags,input:formTags,output:formTags,button:formTags,datalist:formTags,textarea:formTags,option:{option:!0},optgroup:{optgroup:!0}},emptyTags={__proto__:null,area:!0,base:!0,basefont:!0,br:!0,col:!0,frame:!0,hr:!0,img:!0,input:!0,isindex:!0,link:!0,meta:!0,param:!0,embed:!0};require("util").inherits(Parser,require("events").EventEmitter),Parser.prototype.ontext=function(e){this._cbs.ontext&&this._cbs.ontext(e)},Parser.prototype.onopentagname=function(e){if(this._options.lowerCaseTags&&(e=e.toLowerCase()),this._tagname=e,!this._options.xmlMode&&e in openImpliesClose)for(var t;(t=this._stack[this._stack.length-1])in openImpliesClose[e];this.onclosetag(t));!this._options.xmlMode&&e in emptyTags||this._stack.push(e),this._cbs.onopentagname&&this._cbs.onopentagname(e),this._cbs.onopentag&&(this._attribs={})},Parser.prototype.onopentagend=function(){""!==this._attribname&&this.onattribvalue(""),this._attribs&&(this._cbs.onopentag&&this._cbs.onopentag(this._tagname,this._attribs),this._attribs=null),!this._options.xmlMode&&this._cbs.onclosetag&&this._tagname in emptyTags&&this._cbs.onclosetag(this._tagname),this._tagname=""},Parser.prototype.onclosetag=function(e){if(this._options.lowerCaseTags&&(e=e.toLowerCase()),this._stack.length&&(!(e in emptyTags)||this._options.xmlMode)){var t=this._stack.lastIndexOf(e);if(-1!==t)if(this._cbs.onclosetag)for(t=this._stack.length-t;t--;)this._cbs.onclosetag(this._stack.pop());else this._stack.splice(t)}},Parser.prototype.onselfclosingtag=function(){var e=this._tagname;this.onopentagend(),this._stack[this._stack.length-1]===e&&(this._cbs.onclosetag?this._cbs.onclosetag(this._stack.pop()):this._stack.pop())},Parser.prototype.onattribname=function(e){""!==this._attribname&&this.onattribvalue(""),this._options.lowerCaseAttributeNames&&(e=e.toLowerCase()),this._attribname=e},Parser.prototype.onattribvalue=function(e){this._cbs.onattribute&&this._cbs.onattribute(this._attribname,e),this._attribs&&(this._attribs[this._attribname]=e),this._attribname=""},Parser.prototype.ondeclaration=function(e){if(this._cbs.onprocessinginstruction){var t=e.split(/\s|\//,1)[0];this._options.lowerCaseTags&&(t=t.toLowerCase()),this._cbs.onprocessinginstruction("!"+t,"!"+e)}},Parser.prototype.onprocessinginstruction=function(e){if(this._cbs.onprocessinginstruction){var t=e.split(/\s|\//,1)[0];this._options.lowerCaseTags&&(t=t.toLowerCase()),this._cbs.onprocessinginstruction("?"+t,"?"+e)}},Parser.prototype.oncomment=function(e){this._cbs.oncomment&&this._cbs.oncomment(e),this._cbs.oncommentend&&this._cbs.oncommentend()},Parser.prototype.oncdata=function(e){this._cbs.oncdatastart&&this._cbs.oncdatastart(),this._cbs.ontext&&this._cbs.ontext(e),this._cbs.oncdataend&&this._cbs.oncdataend()},Parser.prototype.onerror=function(e){this._cbs.onerror&&this._cbs.onerror(e)},Parser.prototype.onend=function(){if(this._cbs.onclosetag)for(var e=this._stack.length;e>0;this._cbs.onclosetag(this._stack[--e]));this._cbs.onend&&this._cbs.onend()},Parser.prototype.reset=function(){this._cbs.onreset&&this._cbs.onreset(),this._tokenizer.reset(),this._tagname="",this._attribname="",this._attribs=null,this._stack=[],this._done=!1},Parser.prototype.parseComplete=function(e){this.reset(),this.end(e)},Parser.prototype.write=function(e){this._done&&this.onerror(Error(".write() after done!")),this._tokenizer.write(e)},Parser.prototype.end=function(e){this._done&&this.onerror(Error(".end() after done!")),this._tokenizer.end(e),this._done=!0},Parser.prototype.parseChunk=Parser.prototype.write,Parser.prototype.done=Parser.prototype.end,module.exports=Parser;